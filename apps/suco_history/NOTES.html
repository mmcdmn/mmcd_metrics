<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SUCO Analysis Dashboard - Technical Notes</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            color: #333;
        }
        h1 {
            color: #2c3e50;
            border-bottom: 3px solid #3498db;
            padding-bottom: 10px;
        }
        h2 {
            color: #34495e;
            border-bottom: 2px solid #95a5a6;
            padding-bottom: 5px;
            margin-top: 30px;
        }
        h3 {
            color: #555;
            margin-top: 20px;
        }
        h4 {
            color: #666;
            margin-top: 15px;
        }
        code {
            background-color: #f4f4f4;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
        }
        pre {
            background-color: #f4f4f4;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            border-left: 4px solid #3498db;
        }
        pre code {
            background-color: transparent;
            padding: 0;
        }
        ul, ol {
            margin-left: 20px;
        }
        li {
            margin-bottom: 5px;
        }
        strong {
            color: #2c3e50;
        }
        .note {
            background-color: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 10px;
            margin: 15px 0;
        }
        .critical {
            background-color: #f8d7da;
            border-left: 4px solid #dc3545;
            padding: 10px;
            margin: 15px 0;
        }
        .example {
            background-color: #e7f3fe;
            border-left: 4px solid #2196F3;
            padding: 10px;
            margin: 15px 0;
        }
        .success {
            background-color: #d4edda;
            border-left: 4px solid #28a745;
            padding: 10px;
            margin: 15px 0;
        }
        table {
            border-collapse: collapse;
            width: 100%;
            margin: 15px 0;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #3498db;
            color: white;
        }
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        @media print {
            body {
                max-width: 100%;
                font-size: 11pt;
            }
            h1 {
                page-break-before: always;
            }
            h1:first-child {
                page-break-before: avoid;
            }
            h2, h3 {
                page-break-after: avoid;
            }
            pre {
                page-break-inside: avoid;
            }
        }
    </style>
</head>
<body>

<h1>SUCO Analysis Dashboard - Technical Notes</h1>

<h2>Overview</h2>
<p>This Shiny app provides comprehensive analysis of SUCO inspections across multiple perspectives:</p>
<ol>
    <li><strong>Current Data</strong> - Analysis of current year SUCO inspections</li>
    <li><strong>All Data (Current + Archive)</strong> - Historical analysis combining current and archived data</li>
</ol>

<p>Each perspective includes:</p>
<ul>
    <li><strong>Graph</strong> - Time series visualization of SUCO counts</li>
    <li><strong>Map</strong> - Spatial distribution of SUCO locations</li>
    <li><strong>Summary Table</strong> - Aggregated statistics by facility/FOS</li>
    <li><strong>Detailed Samples</strong> - Individual SUCO inspection records</li>
    <li><strong>Top Locations</strong> - Most visited locations or locations with most species</li>
</ul>

<h2>Data Sources</h2>

<h3>Tables Used</h3>

<h4>Primary Inspection Tables</h4>
<ul>
    <li><strong>dbadult_insp_current</strong> - Active adult surveillance inspection records
        <ul>
            <li>Contains ongoing inspections for current operations</li>
            <li>Fields: <code>id</code>, <code>ainspecnum</code>, <code>facility</code>, <code>foreman</code>, <code>inspdate</code>, <code>sitecode</code>, <code>address1</code>, <code>park_name</code>, <code>survtype</code>, <code>fieldcount</code>, <code>comments</code>, <code>x</code>, <code>y</code>, <code>geometry</code></li>
            <li><strong>survtype = '7'</strong> identifies SUCO inspections</li>
            <li><strong>NOTE</strong>: Does NOT have <code>enddate</code> column</li>
        </ul>
    </li>
    <li><strong>dbadult_insp_archive</strong> - Historical adult surveillance inspection records
        <ul>
            <li>Contains closed/archived inspections from previous years</li>
            <li>Same schema as current table</li>
            <li><strong>NOTE</strong>: Does NOT have <code>enddate</code> column</li>
        </ul>
    </li>
</ul>

<h4>Species Tables</h4>
<ul>
    <li><strong>dbadult_species_current</strong> - Species counts for current inspections
        <ul>
            <li>Links to inspections via <code>ainspecnum</code></li>
            <li>Fields: <code>ainspecnum</code>, <code>spp</code> (species code), <code>cnt</code> (count)</li>
        </ul>
    </li>
    <li><strong>dbadult_species_archive</strong> - Species counts for archived inspections
        <ul>
            <li>Same schema as current species table</li>
        </ul>
    </li>
</ul>

<h4>Supporting Tables</h4>
<ul>
    <li><strong>loc_harborage</strong> - Harborage site lifecycle and assignment tracking
        <ul>
            <li><strong>AUTHORITATIVE SOURCE</strong> for foreman and facility assignments</li>
            <li>Fields: <code>sitecode</code>, <code>facility</code>, <code>foreman</code>, <code>startdate</code>, <code>enddate</code></li>
            <li>Used to determine which FOS/facility was responsible at time of inspection</li>
            <li><strong>Join logic</strong>: <code>s.inspdate >= h.startdate AND (h.enddate IS NULL OR s.inspdate <= h.enddate)</code></li>
        </ul>
    </li>
    <li><strong>gis_sectcode</strong> - Section/zone information
        <ul>
            <li>Links site codes to geographic zones (P1 = zone '1', P2 = zone '2')</li>
            <li>Fields: <code>sectcode</code>, <code>facility</code>, <code>fosarea</code>, <code>zone</code></li>
            <li><strong>Fallback</strong> for facility if harborage doesn't have data</li>
            <li>Join pattern handles directional suffixes (-, N, S, E, W)</li>
        </ul>
    </li>
    <li><strong>lookup_specieslist</strong> - Species name lookup
        <ul>
            <li>Maps species codes to genus and species names</li>
            <li>Fields: <code>sppcode</code>, <code>genus</code>, <code>species</code></li>
        </ul>
    </li>
</ul>

<h3>Survtype Codes</h3>
<ul>
    <li><strong>survtype '7'</strong> - SUCO inspections (this is the focus of the app)</li>
    <li>Other survtypes are filtered out</li>
</ul>

<h3>Data Hierarchy and Fallback Logic</h3>

<div class="success">
    <p>The app uses a cascading fallback approach for facility and foreman assignment:</p>
    <pre><code>-- Facility assignment (in order of preference):
COALESCE(h.facility, g.facility, s.facility) as facility

-- Foreman assignment (in order of preference):
COALESCE(h.foreman, s.foreman) as foreman</code></pre>
    
    <p><strong>Why this hierarchy?</strong></p>
    <ol>
        <li><strong>loc_harborage</strong> is the most accurate source for practical assignments</li>
        <li><strong>gis_sectcode</strong> provides geographic-based facility assignment</li>
        <li><strong>Original inspection data</strong> (<code>s.facility</code>, <code>s.foreman</code>) is the final fallback</li>
    </ol>
</div>

<h2>Query Patterns</h2>

<h3>Current Data Query Pattern</h3>
<pre><code>SELECT
  s.id, s.ainspecnum, 
  COALESCE(h.facility, g.facility, s.facility) as facility,
  COALESCE(h.foreman, s.foreman) as foreman,
  s.inspdate, s.sitecode,
  s.address1, s.park_name, s.survtype, s.fieldcount, s.comments,
  s.x, s.y,
  g.zone
FROM public.dbadult_insp_current s
LEFT JOIN public.loc_harborage h ON s.sitecode = h.sitecode
  AND s.inspdate >= h.startdate 
  AND (h.enddate IS NULL OR s.inspdate <= h.enddate)
LEFT JOIN public.gis_sectcode g ON LEFT(s.sitecode, 6) || '-' = g.sectcode
  OR LEFT(s.sitecode, 6) || 'N' = g.sectcode
  OR LEFT(s.sitecode, 6) || 'S' = g.sectcode
  OR LEFT(s.sitecode, 6) || 'E' = g.sectcode
  OR LEFT(s.sitecode, 6) || 'W' = g.sectcode
WHERE s.survtype = '7'
  AND s.inspdate BETWEEN [start_date] AND [end_date]</code></pre>

<h3>All Data Query Pattern</h3>
<p>Same as current data query, but queries both <code>dbadult_insp_current</code> and <code>dbadult_insp_archive</code>, then combines with <code>bind_rows()</code>.</p>

<h3>Species Data Integration</h3>
<p>After retrieving inspection data:</p>
<ol>
    <li>Query species tables for all <code>ainspecnum</code> values</li>
    <li>Join with <code>lookup_specieslist</code> for species names</li>
    <li>Use enhanced species mapping from <code>db_helpers.R</code></li>
    <li>Create species summary for each SUCO inspection</li>
</ol>

<h2>Key Features</h2>

<h3>Date Controls</h3>

<h4>Date Shortcut Buttons</h4>
<ul>
    <li><strong>This Year</strong> - Sets date range to Jan 1 of current year through today</li>
    <li><strong>This Month</strong> - Sets date range to first day of current month through today</li>
    <li><strong>This Week</strong> - Sets date range to Monday of current week through today</li>
</ul>

<h4>Year Range Slider (All Data Tab Only)</h4>
<ul>
    <li>Allows multi-year selection for historical analysis</li>
    <li>Min: 2015, Max: Current year</li>
    <li>Automatically syncs with custom date range</li>
</ul>

<h4>Custom Date Range</h4>
<ul>
    <li>Allows precise date selection</li>
    <li>Behavior depends on active tab:
        <ul>
            <li><strong>Current Data Tab</strong>: Restricted to current year only</li>
            <li><strong>All Data Tab</strong>: Full date range available</li>
        </ul>
    </li>
</ul>

<h3>Grouping Options</h3>
<ul>
    <li><strong>MMCD (All)</strong> - Aggregates all SUCOs across entire organization</li>
    <li><strong>Facility</strong> - Groups by facility assignment</li>
    <li><strong>FOS (Field Operations Supervisor)</strong> - Groups by foreman assignment</li>
</ul>

<h3>Filter Options</h3>
<ul>
    <li><strong>Zone Filter</strong> - P1 + P2, P1 only, or P2 only</li>
    <li><strong>Facility Filter</strong> - Multi-select dropdown</li>
    <li><strong>FOS Filter</strong> - Multi-select, dynamically populated</li>
    <li><strong>Species Filter</strong> - Single-select, filters to SUCOs containing selected species</li>
</ul>

<h3>Graph Types</h3>
<ul>
    <li>Bar - Side-by-side bars</li>
    <li>Stacked Bar - Stacked bars (default)</li>
    <li>Line - Line chart</li>
    <li>Point - Scatter plot</li>
    <li>Area - Filled area chart</li>
</ul>

<h2>Tab 1: Graph</h2>

<h3>Purpose</h3>
<p>Visualize SUCO inspection trends over time, grouped by facility, FOS, or all MMCD.</p>

<h3>Key Features</h3>
<ul>
    <li><strong>Time Interval</strong>: Weekly (Monday start date)</li>
    <li><strong>Average Line</strong> (All Data tab only): Shows average SUCOs per week across entire date range</li>
    <li><strong>Year Boundaries</strong>: Vertical lines separate different years</li>
    <li><strong>Epi Week Labels</strong>: X-axis uses epidemiological week numbers</li>
</ul>

<h3>Calculation Logic</h3>

<h4>Step 1: Aggregate by Time Group</h4>
<pre><code>data %>%
  mutate(time_group = week_start) %>%  # Monday of each week
  group_by(time_group, [group_by_column]) %>%
  summarize(
    count = n(),
    total_fieldcount = sum(fieldcount, na.rm = TRUE),
    epi_week_label = first(epi_week_label),
    .groups = "drop"
  )</code></pre>

<h4>Step 2: Create Plot with Color Mapping</h4>
<ul>
    <li><strong>Facility grouping</strong>: Uses <code>get_facility_base_colors()</code></li>
    <li><strong>FOS grouping</strong>: Maps foreman numbers to facility-based colors via <code>get_foreman_colors()</code></li>
    <li><strong>MMCD grouping</strong>: Single blue color</li>
</ul>

<h4>Step 3: Add Average Line (All Data Only)</h4>
<pre><code># Calculate total SUCOs per week (across all groups)
weekly_totals <- data %>%
  group_by(time_group) %>%
  summarize(total_count = sum(count, na.rm = TRUE))

avg_sucos_per_week <- mean(weekly_totals$total_count, na.rm = TRUE)

# Add horizontal line at average
geom_hline(yintercept = avg_sucos_per_week, color = "red", linetype = "dashed")</code></pre>

<h2>Tab 2: Map</h2>

<h3>Purpose</h3>
<p>Display spatial distribution of SUCO inspections with interactive markers.</p>

<h3>Marker Sizing Logic</h3>
<p>Markers are sized based on species count using a staged approach:</p>
<pre><code>marker_size = case_when(
  display_species_count == 0 ~ 4,      # No species
  display_species_count == 1 ~ 6,      # 1 species
  display_species_count <= 5 ~ 8,      # 2-5 species
  display_species_count <= 10 ~ 10,    # 6-10 species
  display_species_count <= 20 ~ 12,    # 11-20 species
  display_species_count <= 30 ~ 14,    # 21-30 species
  display_species_count <= 50 ~ 16,    # 31-50 species
  display_species_count <= 75 ~ 18,    # 51-75 species
  display_species_count <= 100 ~ 20,   # 76-100 species
  TRUE ~ 22                             # 100+ species
)</code></pre>

<h3>Overlapping Point Handling</h3>
<p>When multiple SUCOs occur at the same location:</p>
<pre><code># Add small random offset (max 0.0001 degrees ≈ 11 meters)
longitude_adj = longitude + runif(n(), -0.0001, 0.0001)
latitude_adj = latitude + runif(n(), -0.0001, 0.0001)</code></pre>

<h3>Color Schemes</h3>
<ul>
    <li><strong>Facility Map</strong> - Each facility has a distinct color</li>
    <li><strong>FOS Map</strong> - Colors are facility-based (same facility = similar color shades)</li>
    <li><strong>MMCD Map</strong> - Single blue color (<code>#1f77b4</code>)</li>
</ul>

<h3>Basemap Options</h3>
<ul>
    <li>OpenStreetMap - Standard OSM tiles</li>
    <li>Carto Light - Clean, minimal basemap (default)</li>
    <li>Terrain - Topographic map</li>
    <li>Esri Satellite - Satellite imagery</li>
</ul>

<h2>Tab 3: Summary Table</h2>

<h3>Purpose</h3>
<p>Provide aggregated statistics grouped by facility or FOS.</p>

<h3>Columns</h3>

<h4>MMCD (All) Grouping</h4>
<table>
    <tr>
        <th>Column</th>
        <th>Description</th>
    </tr>
    <tr>
        <td>Total_SUCOs</td>
        <td>Total number of SUCO inspections</td>
    </tr>
    <tr>
        <td>Total_Locations</td>
        <td>Count of unique sitecodes</td>
    </tr>
    <tr>
        <td>Total_Species_Count</td>
        <td>Sum of all species counts</td>
    </tr>
    <tr>
        <td>First_SUCO</td>
        <td>Earliest inspection date</td>
    </tr>
    <tr>
        <td>Last_SUCO</td>
        <td>Most recent inspection date</td>
    </tr>
</table>

<h4>Facility Grouping</h4>
<table>
    <tr>
        <th>Column</th>
        <th>Description</th>
    </tr>
    <tr>
        <td>Facility</td>
        <td>Facility short code</td>
    </tr>
    <tr>
        <td>Facility_Name</td>
        <td>Facility full name</td>
    </tr>
    <tr>
        <td>Total_SUCOs</td>
        <td>Total SUCO inspections</td>
    </tr>
    <tr>
        <td>Total_Locations</td>
        <td>Unique locations</td>
    </tr>
    <tr>
        <td>Total_Species_Count</td>
        <td>Sum of species counts</td>
    </tr>
    <tr>
        <td>First_SUCO</td>
        <td>Earliest inspection</td>
    </tr>
    <tr>
        <td>Last_SUCO</td>
        <td>Most recent inspection</td>
    </tr>
</table>

<h4>FOS Grouping</h4>
<table>
    <tr>
        <th>Column</th>
        <th>Description</th>
    </tr>
    <tr>
        <td>FOS</td>
        <td>Foreman employee number</td>
    </tr>
    <tr>
        <td>Name</td>
        <td>Foreman short name</td>
    </tr>
    <tr>
        <td>Facility</td>
        <td>Assigned facility</td>
    </tr>
    <tr>
        <td>Total_SUCOs</td>
        <td>Total SUCO inspections</td>
    </tr>
    <tr>
        <td>Total_Locations</td>
        <td>Unique locations</td>
    </tr>
    <tr>
        <td>Total_Species_Count</td>
        <td>Sum of species counts</td>
    </tr>
    <tr>
        <td>First_SUCO</td>
        <td>Earliest inspection</td>
    </tr>
    <tr>
        <td>Last_SUCO</td>
        <td>Most recent inspection</td>
    </tr>
</table>

<h3>Key Features</h3>
<ul>
    <li><strong>Includes zeros</strong>: Shows all facilities/foremen even with 0 SUCOs in selected date range</li>
    <li><strong>Sorted by activity</strong>: Ordered by Total_SUCOs descending</li>
    <li><strong>Searchable</strong>: Built-in search functionality</li>
    <li><strong>Paginated</strong>: 15 rows per page</li>
</ul>

<h2>Tab 4: Detailed Samples</h2>

<h3>Purpose</h3>
<p>Show individual SUCO inspection records with full details.</p>

<h3>Columns</h3>
<ul>
    <li><strong>Date</strong> - Inspection date</li>
    <li><strong>Facility</strong> - Facility full name</li>
    <li><strong>FOS</strong> - Foreman short name</li>
    <li><strong>Zone</strong> - P1 or P2</li>
    <li><strong>Sitecode</strong> - Site identifier</li>
    <li><strong>Location</strong> - Park name or address</li>
    <li><strong>Species_Count</strong> - Total count (or filtered species count)</li>
    <li><strong>Species_Found</strong> - Semicolon-separated species list with counts</li>
</ul>

<h3>Filtering Behavior</h3>
<p>When a species filter is applied:</p>
<ul>
    <li>Only shows SUCOs containing that species</li>
    <li>Species_Count shows count of filtered species only</li>
    <li>Sorted by Species_Count descending</li>
</ul>

<h3>Display Features</h3>
<ul>
    <li><strong>Scrollable</strong>: Horizontal scroll for wide content</li>
    <li><strong>Searchable</strong>: Can search across all columns</li>
    <li><strong>Paginated</strong>: 25 rows per page</li>
    <li><strong>Truncated species list</strong>: Long species lists are abbreviated with "..."</li>
</ul>

<h2>Tab 5: Top Locations</h2>

<h3>Purpose</h3>
<p>Identify and visualize locations with most SUCO activity or highest species diversity.</p>

<h3>Display Modes</h3>

<h4>Most Visited</h4>
<ul>
    <li>Shows top 25 locations by number of SUCO samples</li>
    <li>Each horizontal segment = one SUCO sample</li>
    <li>Color gradient = sample date (older → darker, newer → lighter)</li>
    <li>Y-axis label: "Individual Samples"</li>
</ul>

<h4>Most Species</h4>
<ul>
    <li>Shows top 25 locations by total species count</li>
    <li>Each horizontal segment = one SUCO sample with species count</li>
    <li>Color gradient = sample date</li>
    <li>Y-axis label: "Species Count per Sample"</li>
    <li>When species filter applied: shows count of that specific species</li>
</ul>

<h3>Interactive Features</h3>
<ul>
    <li><strong>Click to map</strong>: Clicking a bar switches to Map tab and zooms to that location</li>
    <li><strong>Hover details</strong>: Shows date, location, and species found</li>
    <li><strong>Stacked bars</strong>: Multiple samples at same location stack vertically</li>
</ul>

<h2>Code Organization</h2>

<h3>File Structure</h3>
<pre><code>suco_history/
├── app.R                    # Main UI and server logic
├── data_functions.R         # Database queries and data processing
├── display_functions.R      # Visualization functions
└── ui_helpers.R             # UI interaction handlers</code></pre>

<h3>Design Principles</h3>
<ol>
    <li><strong>Separation of Concerns</strong>: UI/server in <code>app.R</code>, all SQL in <code>data_functions.R</code></li>
    <li><strong>No SQL in app.R</strong>: Every query wrapped in a function</li>
    <li><strong>Reusable Components</strong>: Same map/plot/table functions for both current and all data</li>
    <li><strong>Consistent Patterns</strong>: Parallel structure for current and all data tabs</li>
</ol>

<h3>Function Files</h3>

<h4>data_functions.R</h4>
<p>Core data retrieval and processing:</p>
<ul>
    <li><code>get_available_species(date_range)</code> - Populate species filter dropdown</li>
    <li><code>get_suco_data(data_source, date_range)</code> - Main data query function</li>
    <li><code>filter_suco_data(data, ...)</code> - Apply user filters</li>
    <li><code>create_spatial_data(data, species_filter)</code> - Prepare data for mapping</li>
    <li><code>aggregate_suco_data(data, group_by, zone_filter)</code> - Time series aggregation</li>
    <li><code>create_summary_stats(data, group_by, data_source)</code> - Summary table data</li>
    <li><code>get_top_locations(data, mode, species_filter)</code> - Top locations data</li>
    <li><code>create_detailed_samples_table(data, species_filter)</code> - Detailed table data</li>
</ul>

<h4>display_functions.R</h4>
<p>Visualization rendering:</p>
<ul>
    <li><code>create_suco_map(data, input, data_source)</code> - Leaflet map creation</li>
    <li><code>create_location_plotly(data, data_source, mode)</code> - Top locations chart</li>
    <li><code>create_trend_plot(aggregated_data, ...)</code> - Time series plot</li>
    <li><code>convert_zone_selection(zone_input)</code> - Helper for zone filtering</li>
</ul>

<h4>ui_helpers.R</h4>
<p>UI interaction handlers:</p>
<ul>
    <li><code>handle_date_shortcut(shortcut_type, ...)</code> - Date button handlers</li>
    <li><code>handle_year_range_change(...)</code> - Year slider updates</li>
    <li><code>handle_date_range_change(...)</code> - Date picker updates</li>
    <li><code>set_updating_flags(...)</code> - Prevent infinite update loops</li>
</ul>

<h3>Shared Utilities (shared/db_helpers.R)</h3>
<ul>
    <li><code>get_db_connection()</code> - Database connection helper</li>
    <li><code>get_facility_lookup()</code> - Facility codes and full names</li>
    <li><code>get_foremen_lookup()</code> - Foreman numbers, names, and facilities</li>
    <li><code>get_facility_base_colors()</code> - Color mapping for facilities</li>
    <li><code>get_foreman_colors()</code> - Color mapping for foremen (facility-based)</li>
    <li><code>get_species_lookup()</code> - Species code to name mapping</li>
    <li><code>get_enhanced_species_mapping()</code> - Enhanced species display names</li>
</ul>

<h2>Common Data Patterns</h2>

<h3>Species Summary Creation</h3>
<p>For each SUCO inspection (<code>ainspecnum</code>):</p>
<ol>
    <li>Join inspection with species tables</li>
    <li>Join species codes with lookup table</li>
    <li>Apply enhanced species mapping</li>
    <li>Aggregate species by name and count</li>
    <li>Format as HTML for popups:
        <pre><code>Species Name 1: 50
Species Name 2: 32
Species Name 3: 15
Others: 25</code></pre>
    </li>
    <li>Limit to top 5 species to keep popups manageable</li>
</ol>

<hr>
<p style="text-align: center; color: #999; margin-top: 40px;">
    <em>Last updated: November 2025</em>
</p>

</body>
</html>