# MMCD Shiny Server Configuration

run_as shiny;

# Enable preserving logs for debugging
preserve_logs true;

# Global defaults for all apps
# Note: These can be overridden per-location
# frame_options sameorigin;  # Commented out to allow iframe embedding from external domains

# ---------------------------------------------------------------------------
# CONCURRENCY NOTE (Shiny Server Open Source)
# simple_scheduler N = ONE R process per app, max N connections to it.
# R is single-threaded, so one slow request blocks others on the same process.
# behind nginx (see startup.sh / nginx.conf). Each instance gets its own
# R process per app, so users on different instances run in parallel.
# ---------------------------------------------------------------------------
simple_scheduler 15;
app_idle_timeout 220;

server {
  listen 3838;

  # Serve static dashboard at root
  location / {
    site_dir /srv/shiny-server;
    directory_index on;
    log_dir /var/log/shiny-server;
  }

  # Serve each Shiny app from its subdirectory
  location /test-app {
    app_dir /srv/shiny-server/apps/test-app;
    log_dir /var/log/shiny-server;
  }

  location /overview {
    app_dir /srv/shiny-server/apps/overview/unified;
    log_dir /var/log/shiny-server;
  }

  # Legacy URL redirects - redirect old URLs to unified app
  # These use redirect instead of app_dir to preserve URL parameters
  location /district_overview {
    redirect "http://$host/overview/?view=district";
  }

  location /facilities_overview {
    redirect "http://$host/overview/?view=facility";
  }

  location /mosquito-monitoring {
    app_dir /srv/shiny-server/apps/mosquito-monitoring;
    log_dir /var/log/shiny-server;
  }

  location /mosquito_surveillance_map {
    app_dir /srv/shiny-server/apps/mosquito_surveillance_map;
    log_dir /var/log/shiny-server;
  }

  location /suco_history {
    app_dir /srv/shiny-server/apps/suco_history;
    log_dir /var/log/shiny-server;
  }

  location /drone {
    app_dir /srv/shiny-server/apps/drone;
    log_dir /var/log/shiny-server;
  }

  location /struct_trt {
    app_dir /srv/shiny-server/apps/struct_trt;
    log_dir /var/log/shiny-server;
  }

  location /cattail_inspections {
    app_dir /srv/shiny-server/apps/cattail_inspections;
    log_dir /var/log/shiny-server;
  }

  location /cattail_treatments {
    app_dir /srv/shiny-server/apps/cattail_treatments;
    log_dir /var/log/shiny-server;
  }

  location /control_efficacy {
    app_dir /srv/shiny-server/apps/control_efficacy;
    log_dir /var/log/shiny-server;
  }

  location /ground_prehatch_progress {
    app_dir /srv/shiny-server/apps/ground_prehatch_progress;
    log_dir /var/log/shiny-server;
  }

  location /catch_basin_status {
    app_dir /srv/shiny-server/apps/catch_basin_status;
    log_dir /var/log/shiny-server;
  }

    location /inspections {
      app_dir /srv/shiny-server/apps/inspections;
      log_dir /var/log/shiny-server;
    }

    # Red Air Pipeline
    location /air_sites_simple {
      app_dir /srv/shiny-server/apps/air_sites_simple;
      log_dir /var/log/shiny-server;
    }

    # About page (static content)
    location /about {
      site_dir /srv/shiny-server/apps/about;
      directory_index on;
      log_dir /var/log/shiny-server;
    }
    
    # Trap surveillance test app
    location /trap_survillance_test {
      app_dir /srv/shiny-server/apps/trap_survillance_test;
      log_dir /var/log/shiny-server;
    }
    
    # Section Cards
    location /section-cards {
      app_dir /srv/shiny-server/apps/section-cards;
      log_dir /var/log/shiny-server;
    }
}
