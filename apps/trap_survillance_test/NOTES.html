<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trap Surveillance Test App - Technical Documentation</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            line-height: 1.6;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background-color: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1 {
            color: #2c3e50;
            border-bottom: 3px solid #3498db;
            padding-bottom: 10px;
        }
        h2 {
            color: #34495e;
            margin-top: 30px;
            border-bottom: 2px solid #ecf0f1;
            padding-bottom: 8px;
        }
        h3 {
            color: #7f8c8d;
            margin-top: 20px;
        }
        h4 {
            color: #95a5a6;
            margin-top: 15px;
        }
        code {
            background-color: #f8f9fa;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            color: #e74c3c;
        }
        pre {
            background-color: #2c3e50;
            color: #ecf0f1;
            padding: 20px;
            border-radius: 5px;
            overflow-x: auto;
            margin: 15px 0;
            border: 1px solid #34495e;
        }
        pre code {
            background-color: transparent;
            color: #ecf0f1;
            padding: 0;
            border-radius: 0;
            font-size: 0.85em;
        }
        ul, ol {
            margin: 10px 0;
            padding-left: 30px;
        }
        li {
            margin: 5px 0;
        }
        blockquote {
            border-left: 4px solid #3498db;
            background-color: #f8f9fa;
            padding: 10px 20px;
            margin: 20px 0;
            font-style: italic;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }
        th {
            background-color: #f5f5f5;
            font-weight: bold;
        }
        hr {
            border: none;
            height: 2px;
            background-color: #ecf0f1;
            margin: 20px 0;
        }
        p {
            margin: 10px 0;
        }
        a {
            color: #3498db;
            text-decoration: none;
        }
        a:hover {
            text-decoration: underline;
        }
    </style>
    <!-- KaTeX for LaTeX math rendering -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css" integrity="sha384-n8MVd4RsNIU0tAv4ct0nTaAbDJwPJzDEaqSD1odI+WdtXRGWt2kTvGFasHpSy3SV" crossorigin="anonymous">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js" integrity="sha384-XjKyOOlGwcjNTAIQHIpgOno0Hl1YQqzUOEleOLALmuqehneUG+vnGctmUb0ZY0l8" crossorigin="anonymous"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js" integrity="sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05" crossorigin="anonymous"
        onload="renderMathInElement(document.body, {
          delimiters: [
            {left: '$$', right: '$$', display: true},
            {left: '$', right: '$', display: false},
            {left: '\\[', right: '\\]', display: true},
            {left: '\\(', right: '\\)', display: false}
          ]
        });"></script>
</head>
<body>
    <div class="container">
<h1>Trap Surveillance Test App - Technical Documentation</h1>

<h2>Overview</h2>

<p>This Shiny application analyzes mosquito surveillance data to estimate virus infection risk across geographic sections. It implements <strong>trap-based Maximum Likelihood Estimation (MLE)</strong> with <strong>k-nearest neighbor distance-weighted averaging (k-NN DWA)</strong> for spatial interpolation.</p>

<hr>

<h2>Data Sources</h2>

<h3>Database Tables</h3>

<ol>
<li><strong><code>dbvirus<em>pool</em>test</code></strong>: Virus test results for individual pools</li>
<ul>
<li>Fields: <code>poolnum</code>, <code>result</code> (Pos/Neg), <code>date</code>, <code>target</code> (WNV, etc.), <code>method</code></li>
</ul>
</ul>

<ol>
<li><strong><code>dbvirus_pool</code></strong>: Pool composition metadata</li>
<ul>
<li>Fields: <code>poolnum</code>, <code>sampnum<em>yr</code>, <code>spp</em>code</code>, <code>count</code> (mosquitoes per pool)</li>
</ul>
</ul>

<ol>
<li><strong><code>dbadult<em>insp</em>current</code></strong>: Trap inspection data</li>
<ul>
<li>Fields: <code>sampnum_yr</code>, <code>inspdate</code>, <code>survtype</code> (trap type), <code>count</code> (mosquitoes)</li>
</ul>
</ul>

<ol>
<li><strong><code>loc_mondaynight</code></strong>: Trap location coordinates</li>
<ul>
<li>Fields: <code>sampnum_yr</code>, <code>facility</code>, <code>geometry</code> (spatial point)</li>
</ul>
</ul>

<ol>
<li><strong><code>loc_sect</code></strong>: Section boundary polygons</li>
<ul>
<li>Fields: <code>section</code> (ID), <code>geometry</code> (spatial polygon)</li>
</ul>
</ul>

<h3>Data Relationships</h3>

<pre><code class="">
Pool Test → Pool → Trap Inspection → Trap Location
   (result)   (species)   (count)        (coordinates)
</code></pre>

<h3>Unified SQL Query </h3>

<p><strong>Function</strong>: <code>fetch<em>unified</em>surveillance_data()</code>  </p>
<p>The app uses a <strong>unified SQL query</strong> with Common Table Expressions (CTEs) to fetch all trap and pool data in one database round trip:</p>

<pre><code class="sql">
WITH 
-- CTE 1: Latest trap inspections per unique physical location
latest_traps AS (
  SELECT DISTINCT ON (t.x, t.y, t.facility)
    t.ainspecnum, t.facility, t.x, t.y, t.survtype, t.inspdate,
    COALESCE(SUM(s.cnt), 0) as species_count
  FROM public.dbadult_insp_current t
  LEFT JOIN public.dbadult_species_current s 
    ON t.ainspecnum = s.ainspecnum
    AND s.spp IN (...)  -- Species filter
  WHERE t.inspdate::date &lt;= :analysis_date
    AND t.x IS NOT NULL AND t.y IS NOT NULL
    AND t.survtype IN (...)  -- Trap type filter (4, 5, 6)
    AND t.facility IN (...)  -- Facility filter
  GROUP BY t.ainspecnum, t.facility, t.x, t.y, t.survtype, t.inspdate
  ORDER BY t.x, t.y, t.facility, t.inspdate DESC
),

-- CTE 2: Virus pool tests with trap location coordinates
virus_pools AS (
  SELECT 
    t.id AS test_id, t.poolnum, t.result, t.date AS testdate,
    t.target, p.sampnum_yr, p.spp_code, p.count,
    ST_X(ST_Transform(
      CASE WHEN c.network_type IS NOT NULL 
           THEN l.geom 
           ELSE c.geometry 
      END, 4326)) as lon,
    ST_Y(ST_Transform(...)) as lat,
    c.facility
  FROM dbvirus_pool_test t
  LEFT JOIN dbvirus_pool p ON p.poolnum = t.poolnum
  LEFT JOIN dbadult_insp_current c ON c.sampnum_yr = p.sampnum_yr
  LEFT JOIN (
    SELECT a.loc_code, n.geom 
    FROM loc_mondaynight_active a 
    LEFT JOIN loc_mondaynight n ON n.loc_code = a.loc_code
    WHERE a.enddate IS NULL
  ) l ON l.loc_code = c.loc_code
  WHERE t.date &gt;= :analysis_date - INTERVAL ':lookback_days days'
    AND t.date &lt;= :analysis_date
    AND t.target = :virus_target  -- WNV, LAC, EEE
    AND c.survtype IN (...)  -- Trap type filter
    AND c.facility IN (...)  -- Facility filter
    AND p.spp_code IN (...)  -- Species filter
)

-- Union: Return unified result set with sampnum_yr for pool grouping
SELECT 'trap' as data_type, ainspecnum as id, ..., NULL as sampnum_yr FROM latest_traps
UNION ALL
SELECT 'pool' as data_type, poolnum::text as id, ..., sampnum_yr FROM virus_pools
WHERE lon IS NOT NULL AND lat IS NOT NULL;
</code></pre>



<h2>Methodology</h2>

<h3>Two-Stage Trap-Based MLE Calculation</h3>

<h4>Stage 1: Per-Trap MLE Calculation</h4>

<p><strong>Purpose</strong>: Calculate a single MLE for each trap using all pools tested at that trap</p>

<p><strong>Filters Applied</strong>:</p>
<ul>
<li><strong>Date Range</strong>: Last 90 days from analysis date</li>
<li><strong>Virus Target</strong>: WNV, LAC, or EEE (user selectable)</li>
<li><strong>Species</strong>: User-selected species codes (or all)</li>
<li><strong>Trap Types</strong>: User-selected trap types (4=Elevated CO2, 5=Gravid, 6=CO2 Overnight)</li>
</ul>

<p><strong>Process</strong>:</p>
<ol>
<li>Query all pool tests matching filters</li>
<li>Join with trap inspection data to filter by <code>survtype</code> (trap type)</li>
<li>Group pools by <code>sampnum_yr</code> (trap ID)</li>
<li>For each trap:</li>
<ul>
<li>Extract pool test results: <code>x</code> = binary vector (1=Pos, 0=Neg)</li>
<li>Extract pool sizes: <code>m</code> = mosquitoes per pool</li>
<li>Call <code>PooledInfRate::pooledBin()</code> directly</li>
<li>Calculate MLE with 95% confidence interval</li>
<li>Result: One MLE per trap with metadata (num<em>pools, num</em>positive, total_mosquitoes)</li>
</ul>
</ul>

<p><strong>Example</strong>:</p>
<pre><code class="">
Trap 25-91099 (Elevated CO2, Culex pipiens):
  - Pool 1: 50 mosquitoes, Negative
  - Pool 2: 45 mosquitoes, Negative
  - Pool 3: 52 mosquitoes, Negative
  - Pool 4: 48 mosquitoes, Negative
  
→ MLE = 0 per 1000 (CI: 0.00 - 298.67)
</code></pre>

<h4>Stage 2: k-NN Distance-Weighted Averaging for Sections</h4>

<p><strong>Purpose</strong>: Assign infection rate estimates to sections using spatially-weighted interpolation from nearby trap MLEs</p>

<p><strong>Mathematical Formulation</strong>:</p>

<p>For each section $s$ with centroid location $\mathbf{c}_s$:</p>

<ol>
<li><strong>Identify k-Nearest Traps</strong>: Find the set of $k$ nearest trap locations $\\{\mathbf{t}_1, \mathbf{t}_2, \ldots, \mathbf{t}_k\\}$</li>
</ul>

<ol>
<li><strong>Calculate Distances</strong>: Compute geodesic distances</li>
</ul>

<p>   $$d_i = \text{distance}(\mathbf{c}_s, \mathbf{t}_i) \quad \text{for } i = 1, 2, \ldots, k$$</p>

<ol>
<li><strong>Inverse Distance Weighting</strong>: Calculate weights using inverse distance squared</li>
</ul>

<p>   $$w_i = \frac{1}{d_i^2}$$</p>

<ol>
<li><strong>Normalize Weights</strong>: Ensure weights sum to unity</li>
</ul>

<p>   $$\hat{w}_i = \frac{w_i}{\sum_{j=1}^{k} w_j}$$</p>

<ol>
<li><strong>Weighted Average MLE</strong>: Compute section MLE as weighted mean</li>
</ul>

<p>   $$\text{MLE}_s = \sum_{i=1}^{k} \hat{w}_i \cdot \text{MLE}_{\mathbf{t}_i}$$</p>

<p>   where $\text{MLE}_{\mathbf{t}_i}$ is the trap-level MLE calculated in Stage 1.</p>

<p><strong>Vector Index Calculation</strong>:</p>

<p>The Vector Index for section $s$ combines population density and infection probability:</p>

<p>$$\text{VI}_s = N_s \times P_s$$</p>

<p>where:</p>

<ul>
<li>$N_s$ = Population Index (k-NN inverse-distance-weighted average of trap mosquito counts)</li>
<li>$P_s = \frac{\text{MLE}_s}{1000}$ (infection probability scaled per 1000 mosquitoes)</li>
</ul>

<p><strong>Process</strong>:</p>
<ol>
<li>Calculate centroid for each section polygon</li>
<li>For each section centroid:</li>
<ul>
<li>Find k nearest trap locations (default k=4)</li>
<li>Calculate geodesic distance (great circle) to each trap</li>
<li>Apply inverse distance squared weighting: <code>weight = 1 / distance²</code></li>
<li>Normalize weights to sum to 1</li>
<li>Calculate section MLE as weighted average: <code>Σ(trap_MLE × weight)</code></li>
<li>Aggregate statistics:</li>
<li>Count unique trap locations used</li>
<li>Sum total pools from all traps</li>
<li>Sum positive pools from all traps</li>
<li>Track nearest and farthest distances</li>
<li>Result: Section-level MLE estimates with spatial smoothing and metadata</li>
</ul>
</ul>

<p><strong>Important</strong>: The section's pool counts represent the <strong>sum of all pools from the k nearest traps</strong>, not individual pool tests at that section location.</p>

<p><strong>Pool Grouping Options</strong> (to prevent duplicate distance bug):</p>

<p><strong>Option 1: By Trap Location (Recommended)</strong></p>
<ul>
<li>Groups pools by unique trap location (lon, lat) coordinates first</li>
<li>Finds k nearest trap LOCATIONS (not individual pools)</li>
<li>Uses ALL pools from those k trap locations in the calculation</li>
<li>Assigns same distance to all pools from same physical trap</li>
<li><strong>Why</strong>: Prevents selecting 4 pools all from same trap coordinates</li>
<li><strong>Result</strong>: Proper geographic diversity in k-NN selection</li>
</ul>

<p><strong>Option 2: By Individual Pool</strong></p>
<ul>
<li>Original behavior (for comparison)</li>
<li>Finds k nearest individual pool tests (sampnum_yr)</li>
<li>May select multiple pool tests from same physical trap</li>
<li><strong>Issue</strong>: Can result in identical nearest/farthest distances</li>
</ul>

<p><strong>Example</strong>:</p>
<pre><code class="">
Section 123 (centroid at -92.80, 45.25):
  By Trap Location mode:
    Location A (-92.81, 45.24) @ 1200m → Pools: 25-91099 (4 pools), 25-91100 (3 pools)
    Location B (-92.79, 45.26) @ 1500m → Pools: 25-91101 (5 pools)
    Location C (-92.82, 45.23) @ 1800m → Pools: 25-91102 (4 pools)
  
  Section statistics:
    - Pools used: 4 (individual pool tests)
    - Unique trap locations: 3
    - Total pools: 16 (sum from all 4 pool tests)
    - Positive pools: 2 (sum from all 4 pool tests)
  
  Weighted average MLE:
    Section MLE = (MLE_A × 0.45) + (MLE_B × 0.30) + (MLE_C × 0.25)
</code></pre>

<h3>Distance Weighting Implementation</h3>

<pre><code class="r">
# Inverse distance squared
weights &lt;- 1 / (distances^2)

# Normalize to sum to 1
weights &lt;- weights / sum(weights)

# Weighted average
section_mle &lt;- sum(trap_mles * weights)
</code></pre>
<hr>

<h2>Metrics</h2>

<h3>1. Population Index (N)</h3>

<p><strong>Definition</strong>: Estimated mosquito abundance per section</p>

<p><strong>Calculation</strong>:</p>
<ul>
<li>Sum mosquito counts from trap inspections</li>
<li>Group by pool/inspection (sampnum_yr)</li>
<li>Apply k-NN DWA to assign counts to sections</li>
</ul>

<p><strong>Interpretation</strong>: Higher values = more mosquitoes present</p>

<p><strong>Use case</strong>: Identify areas with high mosquito populations</p>

<hr>

<h3>2. Maximum Likelihood Estimate (MLE)</h3>

<p><strong>Definition</strong>: Estimated virus infection rate per 1,000 mosquitoes</p>

<p><strong>Package</strong>: PooledInfRate (CDC - https://github.com/CDCgov/PooledInfRate)</p>

<p><strong>Available Methods</strong>:</p>

<p>| Method | Description | When to Use |</p>
<p>|--------|-------------|-------------|</p>
<p>| <strong>Firth</strong> | Bias-corrected MLE | <strong>Default</strong> - Best for small samples |</p>
<p>| <strong>Gart</strong> | Score-based method | Classic pooled testing estimator |</p>
<p>| <strong>MLE</strong> | Standard maximum likelihood | Large samples only |</p>
<p>| <strong>MIR</strong> | Minimum infection rate | Simple ratio: positives/total |</p>

<p><strong>Scale</strong>: Default 1,000 (results per 1,000 mosquitoes)</p>

<p><strong>Interpretation</strong>:</p>
<ul>
<li>MLE = 5.2 → "Estimated 5.2 infected mosquitoes per 1,000"</li>
<li>95% CI = (2.1 - 12.8) → "True rate likely between 2.1 and 12.8 per 1,000"</li>
<li>MLE = 0 (CI: 0 - 298.67) → "No positives, but could be as high as 298 per 1,000"</li>
</ul>

<p><strong>Note</strong>: "95% CI" is the confidence LEVEL, not a percentage result</p>
<ul>
<li>It means: "We are 95% confident the true rate is in this range"</li>
<li>Wider intervals = more uncertainty (fewer pools tested)</li>
<li>Narrower intervals = more precision (more data)</li>
</ul>

<hr>

<h3>3. Vector Index (VI)</h3>

<p><strong>Definition</strong>: Combined risk metric = Population × Infection Rate</p>

<p><strong>Formula</strong>: </p>
<pre><code class="r">
VI = N × (MLE / 1000)
</code></pre>

<p><strong>Calculation</strong>:</p>
<ol>
<li>Calculate Population Index (N) using k-NN DWA</li>
<li>Calculate MLE (P) using trap-based k-NN DWA</li>
<li>Multiply at section level: VI = N × P</li>
</ul>

<p><strong>Interpretation</strong>:</p>
<ul>
<li>Units: "Estimated infected mosquitoes per section"</li>
<li>Higher VI = More mosquitoes AND higher infection rate</li>
<li>Better risk indicator than either metric alone</li>
</ul>

<p><strong>Example</strong>:</p>
<pre><code class="">
Section A: N=500 mosquitoes, MLE=10 per 1000
  VI = 500 × (10/1000) = 5 infected mosquitoes
  
Section B: N=100 mosquitoes, MLE=50 per 1000
  VI = 100 × (50/1000) = 5 infected mosquitoes
  
→ Same risk despite different abundance/infection patterns
</code></pre>

<hr>
<h2>File Structure</h2>

<h3>Core Files</h3>

<p>| File | Lines | Purpose |</p>
<p>|------|-------|---------|</p>
<p>| <code>app.R</code> | 181 | Shiny server logic, reactive data pipeline |</p>
<p>| <code>ui_helper.R</code> | 181 | UI layout, input controls, help text |</p>
<p>| <code>data_functions.R</code> | 342 | Database queries, Population Index, Vector Index |</p>
<p>| <code>display_functions.R</code> | 638 | Leaflet map rendering, popups, themes |</p>
<p>| <code>mle<em>trap</em>based.R</code> | 359 | Two-stage trap-based MLE calculation |</p>
<p>| <code>mle_functions.R</code> | 164 | PooledInfRate wrapper, format normalization |</p>

<h3>Shared Resources</h3>

<p>| File | Purpose |</p>
<p>|------|---------|</p>
<p>| <code>../shared/db_helpers.R</code> | Database connection management |</p>
<p>| <code>../shared/color_themes.R</code> | Color palette definitions |</p>

<hr>

<h2>References</h2>

<h3>Scientific Literature</h3>

<ol>
<li><strong>Firth D (1993)</strong>. "Bias reduction of maximum likelihood estimates." <em>Biometrika</em> 80(1):27-38.</li>
<ul>
<li>Bias-corrected MLE method (default)</li>
</ul>
</ul>

<ol>
<li><strong>Gart JJ (1991)</strong>. "An application of score methodology: Confidence intervals and tests of fit for one-hit curves." <em>Biometrics</em> 47(1):173-182.</li>
<ul>
<li>Score-based pooled testing estimator</li>
</ul>
</ul>

<ol>
<li><strong>Walter SD et al. (1980)</strong>. "Estimation of infection rates in populations of organisms using pools of variable size." <em>American Journal of Epidemiology</em> 112(1):124-128.</li>
<ul>
<li>Theory of pooled testing for infection estimation</li>
</ul>
</ul>

<h3>Software</h3>

<ul>
<li><strong>PooledInfRate Package</strong>: https://github.com/CDCgov/PooledInfRate</li>
<ul>
<li>CDC-maintained R package for pooled infection rate estimation</li>
<li>Methods: Firth, Gart, MLE, MIR</li>
</ul>
</ul>

<ul>
<li><strong>k-NN Distance Weighting</strong>: Standard geostatistical interpolation</li>
<ul>
<li>Inverse Distance Weighting (IDW)</li>
<li>Commonly used in spatial analysis and GIS</li>
</ul>
</ul>


<h2>Future Enhancements</h2>

<h3>Potential Improvements</h3>

<ol>
<li><strong>Temporal Analysis</strong>: </li>
<ul>
<li>Time series plots of MLE over weeks/months</li>
<li>Animated maps showing risk evolution</li>
</ul>
</ul>

<ol>
<li><strong>Statistical Testing</strong>:</li>
<ul>
<li>Compare MLEs between sections (significance tests)</li>
<li>Hotspot detection (spatial clustering)</li>
</ul>
</ul>

<ol>
<li><strong>Predictive Models</strong>:</li>
<ul>
<li>Machine learning to predict high-risk areas</li>
<li>Incorporate weather/environmental data</li>
</ul>
</ul>

<ol>
<li><strong>Export Features</strong>:</li>
<ul>
<li>Download section MLE estimates as CSV</li>
<li>Export map as PDF for reports</li>
</ul>
</ul>

<ol>
<li><strong>Performance Optimization</strong>:</li>
<ul>
<li>Cache trap MLE calculations</li>
<li>Parallel processing for section k-NN</li>
</ul>
</ul>

<hr>
    </div>
</body>
</html>
