<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MMCD Analytics Dashboard</title>
    <link rel="icon" type="image/png" href="shared/assets/favicon.ico">
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }

        .apps-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .app-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            background-color: #fafafa;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .app-icon {
            width: 48px;
            height: 48px;
            margin: 0 auto 15px;
            display: block;
        }

        .app-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .app-card h3 {
            color: #2c5aa0;
            margin-bottom: 15px;
        }

        .app-card p {
            color: #666;
            margin-bottom: 20px;
            line-height: 1.5;
        }

        .app-link {
            display: inline-block;
            background-color: #2c5aa0;
            color: white;
            padding: 10px 20px;
            text-decoration: none;
            border-radius: 5px;
            transition: background-color 0.2s;
        }

        .app-link:hover {
            background-color: #1e3d6f;
        }

        .description {
            text-align: center;
            color: #666;
            margin-bottom: 20px;
            font-size: 18px;
        }

        .category {
            color: #2c5aa0;
            font-size: 24px;
            font-weight: bold;
            margin-top: 40px;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #2c5aa0;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>MMCD Analytics Dashboard</h1>
        <p class="description">Metropolitan Mosquito Control District - Data Analysis Applications</p>

        <h2 class="category">Dashboards</h2>
        <div class="apps-grid">
            <div class="app-card">
                <img src="shared/assets/layer-group.jpg" alt="Overview Dashboard" class="app-icon">
                <h3>Overview Dashboard</h3>
                <p>Unified dashboard showing MMCD treatment progress. View district-level aggregation by zone (P1 vs P2), or drill down by zone and metric to see facilities-level and facility-specific data. Includes Catch Basin, Drone, Ground Prehatch, Structures, and Cattail metrics.</p>
                <a href="overview/" class="app-link">Open Dashboard</a>
            </div>
            <div class="app-card">
                <img src="shared/assets/layer-group.jpg" alt="FOS Overview" class="app-icon">
                <h3>FOS Overview Dashboard</h3>
                <p>FOS-level dashboard showing treatment progress for a specific Field Operations Supervisor. Select a facility and FOS area, then view metrics for that individual.</p>
                    <div style="margin-bottom: 10px;">
                        <label style="display: block; font-weight: bold; margin-bottom: 5px; font-size: 12px; color: #333;">Facility:</label>
                        <select id="fos_facility" style="width: 100%; padding: 6px; border: 1px solid #ccc; border-radius: 3px; font-size: 12px;">
                            <option value="" disabled selected>Loading facilities...</option>
                        </select>
                    </div>
                    <div style="margin-bottom: 10px;">
                        <label style="display: block; font-weight: bold; margin-bottom: 5px; font-size: 12px; color: #333;">FOS Area:</label>
                        <select id="fos_area" style="width: 100%; padding: 6px; border: 1px solid #ccc; border-radius: 3px; font-size: 12px;">
                            <option value="" disabled selected>Loading FOS areas...</option>
                        </select>
                    </div>
                    <button onclick="openFOSOverview()" style="width: 100%; background-color: #2c5aa0; color: white; padding: 8px; border: none; border-radius: 3px; cursor: pointer; font-weight: bold; font-size: 12px;">Open Dashboard</button>
            </div>
        </div>

        <h2 class="category">Floodwater</h2>
        <div class="apps-grid">
            <div class="app-card">
                <img src="shared/assets/larvae.png" alt="Larvae" class="app-icon">
                <h3>Inspections Coverage</h3>
                <p>Analyze inspection coverage for all sites, filter by air/ground, FOS area, facility, and zone. Identify sites with no inspection in the last X years using both current and archive records.</p>
                <a href="inspections/" class="app-link">Open Application</a>
            </div>
            <div class="app-card">
                <img src="shared/assets/ground.png" alt="ground" class="app-icon">
                <h3>Ground Prehatch Progress</h3>
                <p>Monitor ground prehatch treatment progress including site counts, treatment status, and coverage metrics. Track treated, expiring, expired, and untreated prehatch sites by facility and zone.</p>
                <a href="ground_prehatch_progress/" class="app-link">Open Application</a>
            </div>
            <div class="app-card">
                <img src="shared/assets/helicopter-solid-full.svg" alt="Air" class="app-icon">
                <h3>Air</h3>
                <p>Air site status tracking and pipeline management for breeding sites. Monitor rainfall, inspections, treatments, and status transitions in the air site workflow.</p>
                <a href="air_sites_simple/" class="app-link">Open Application</a>
            </div>
            <div class="app-card">
                <img src="shared/assets/drone.jpg" alt="Drone" class="app-icon">
                <h3>Drone Treatment</h3>
                <p>Comprehensive drone treatment tracking with real-time progress metrics, historical analysis, and site average calculations. Includes both active treatment monitoring and historical trend visualization.</p>
                <a href="drone/" class="app-link">Open Application</a>
            </div>
        </div>

        <h2 class="category">Vector</h2>
        <div class="apps-grid">
            <div class="app-card">
                <img src="shared/assets/catchbasin.png" alt="Catch Basin" class="app-icon">
                <h3>Catch Basin Progress</h3>
                <p>Monitor catch basin treatment status across facilities. Track wet catch basins, active treatments, and treatment coverage percentages. View summary statistics and detailed breakdowns by facility.</p>
                <a href="catch_basin_status/" class="app-link">Open Application</a>
            </div>
            <div class="app-card">
                <img src="shared/assets/catchbasin.png" alt="Catch Basin" class="app-icon">
                <h3>Structure Progress</h3>
                <p>Comprehensive tracking of structure treatment operations with current progress metrics and historical trends analysis. Includes both active treatment monitoring and historical data visualization.</p>
                <a href="struct_trt/" class="app-link">Open Application</a>
            </div>
            <div class="app-card">
                <img src="shared/assets/tree-solid-full.svg" alt="SUCO" class="app-icon">
                <h3>Suco</h3>
                <p>SUCO historical analysis dashboard with interactive maps, location filtering, and temporal trend analysis. Includes facility and foreman-based grouping.</p>
                <a href="suco_history/" class="app-link">Open Application</a>
            </div>
            <div class="app-card">
                <img src="shared/assets/adult.png" alt="Trap Surveillance" class="app-icon">
                <h3>Trap Surveillance</h3>
                <p>Vector surveillance dashboard showing mosquito abundance, MLE/MIR infection rates, and Vector Index by Vector Index Area. Uses pre-calculated database views for Culex species monitoring.</p>
                <a href="trap_surveillance/" class="app-link">Open Application</a>
            </div>
        </div>

        <h2 class="category">Monday Samples</h2>
        <div class="apps-grid">
            <div class="app-card">
                <img src="shared/assets/adult.png" alt="Mosquito" class="app-icon">
                <h3>Mosquito Surveillance Map</h3>
                <p>Interactive geographic mapping of mosquito surveillance data with species filtering, surveillance type selection, and temporal analysis. Visualize mosquito counts across monitoring locations. This will take some time to load, so be patient.</p>
                <a href="mosquito_surveillance_map/" class="app-link">Open Application</a>
            </div>
            <div class="app-card">
                <img src="shared/assets/adult.png" alt="Mosquito" class="app-icon">
                <h3>Mosquito Monitoring</h3>
                <p>CO2 trap mosquito surveillance data with species analysis, facility comparisons, and zone filtering. Interactive charts with hover details and customizable date ranges.</p>
                <a href="mosquito-monitoring/" class="app-link">Open Application</a>
            </div>
        </div>

        <h2 class="category">Cattail</h2>
        <div class="apps-grid">
            <div class="app-card">
                <img src="shared/assets/cattail_background.png" alt="Cattail" class="app-icon">
                <h3>Cattail Inspections</h3>
                <p>Track cattail inspection progress versus annual goals. Monitor inspection status, coverage metrics, and planned treatments for cattail management sites.</p>
                <a href="cattail_inspections/" class="app-link">Open Application</a>
            </div>
            <div class="app-card">
                <img src="shared/assets/cattail_background.png" alt="Cattail" class="app-icon">
                <h3>Cattail Treatments</h3>
                <p>Comprehensive cattail treatment tracking dashboard. Monitor treatment progress, material usage, acreage treated, and treatment effectiveness by facility and zone.</p>
                <a href="cattail_treatments/" class="app-link">Open Application</a>
            </div>
        </div>

        <h2 class="category">Utilities</h2>
        <div class="apps-grid">
            <div class="app-card">
                <img src="shared/assets/layer-group.jpg" alt="Section Cards" class="app-icon">
                <h3>Section Cards</h3>
                <p>Generate printable section cards for breeding sites and structures with customizable fields and formats.</p>
                <a href="section-cards/" class="app-link">Open Application</a>
            </div>
            <div class="app-card">
                <img src="shared/assets/helicopter-solid-full.svg" alt="Air Checklist" class="app-icon">
                <h3>Air Inspection Checklist</h3>
                    <div style="margin-bottom: 10px;">
                        <label style="display: block; font-weight: bold; margin-bottom: 5px; font-size: 12px; color: #333;">Facility:</label>
                        <select id="air_facility" style="width: 100%; padding: 6px; border: 1px solid #ccc; border-radius: 3px; font-size: 12px;">
                            <option value="" disabled selected>Loading facilities...</option>
                        </select>
                    </div>
                    <div style="margin-bottom: 10px;">
                        <label style="display: block; font-weight: bold; margin-bottom: 5px; font-size: 12px; color: #333;">FOS Area:</label>
                        <select id="air_fos" style="width: 100%; padding: 6px; border: 1px solid #ccc; border-radius: 3px; font-size: 12px;">
                            <option value="" disabled selected>Loading FOS areas...</option>
                        </select>
                    </div>
                    <button onclick="openAirChecklist()" style="width: 100%; background-color: #2c5aa0; color: white; padding: 8px; border: none; border-radius: 3px; cursor: pointer; font-weight: bold; font-size: 12px;">Open Application</button>
            </div>
            <div class="app-card">
                <h3>Admin Tools</h3>
                <p>Administrative tools and utilities. Update cached data when lookups and historical data change.</p>
                <a href="test-app/" class="app-link">Open Application</a>
            </div>
        </div>

        <h2 class="category">Tests</h2>
        <div class="apps-grid">
            <div class="app-card">
                <img src="shared/assets/larvae.png" alt="Larvae" class="app-icon">
                <h3>Control Efficacy</h3>
                <p>Track treatment efficacy through systematic checkback analysis. Monitor checkback completion rates, treatment-to-checkback timing, and dip count changes to measure control effectiveness Between species and material types.</p>
                <a href="control_efficacy/" class="app-link">Open Application</a>
            </div>
            <div class="app-card">
                <img src="shared/assets/adult.png" alt="Mosquito" class="app-icon">
                <h3>Trap Surveillance Test</h3>
                <p>Prototype app to compute section vector index using k-nearest traps.</p>
                <a href="trap_survillance_test/" class="app-link">Open Application</a>
            </div>
        </div>

        <h2 class="category">About</h2>
        <div class="apps-grid">
            <div class="app-card">
                <img src="shared/assets/adult.png" alt="About" class="app-icon">
                <h3>About This Platform</h3>
                <p>Credits and information about the development team behind the MMCD Analytics Platform. Learn about the contributors and technologies used in building these analytical tools.</p>
                <a href="about/" class="app-link">View Credits</a>
            </div>
        </div>

        <div style="margin-top: 40px; text-align: center; color: #999; font-size: 14px;">
            <p>Metropolitan Mosquito Control District | Analytics Platform</p>
        </div>
    </div>

    <script>
        // Store all foremen for filtering
        let allForemen = [];
        
        // Load real facility and FOS options from the air_inspection_checklist app
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('Loading real filter options from database...');
            await loadRealFacilities();
            await loadRealForemen();
            
            // Set up facility change handler to filter FOS options
            document.getElementById('air_facility').addEventListener('change', filterFOSByFacility);
            
            // Also populate FOS overview dropdowns (reuse same data)
            populateFOSOverviewDropdowns();
            document.getElementById('fos_facility').addEventListener('change', filterFOSOverviewByFacility);
        });

        // Load REAL facilities from the air_inspection_checklist Shiny app
        async function loadRealFacilities() {
            try {
                const facilitySelect = document.getElementById('air_facility');
                const jsonUrl = 'air_inspection_checklist/facilities.json';
                
                console.log('Fetching facilities from:', jsonUrl);
                const response = await fetch(jsonUrl);
                
                if (response.ok) {
                    const facilities = await response.json();
                    console.log('Facilities loaded from database:', facilities);
                    
                    facilitySelect.innerHTML = '<option value="all">All Facilities</option>';
                    
                    if (Array.isArray(facilities)) {
                        facilities.forEach(facility => {
                            const option = document.createElement('option');
                            option.value = facility.code;
                            option.textContent = facility.label;
                            facilitySelect.appendChild(option);
                        });
                    }
                } else {
                    console.error('Failed to load facilities - HTTP', response.status);
                    facilitySelect.innerHTML = '<option value="">Unable to load facilities from database</option>';
                }
            } catch (error) {
                console.error('Error loading real facilities:', error);
                document.getElementById('air_facility').innerHTML = '<option value="">Error loading facilities</option>';
            }
        }

        // Load REAL foremen from the air_inspection_checklist Shiny app
        async function loadRealForemen() {
            try {
                const fosSelect = document.getElementById('air_fos');
                const jsonUrl = 'air_inspection_checklist/foremen.json';
                
                console.log('Fetching foremen from:', jsonUrl);
                const response = await fetch(jsonUrl);
                
                if (response.ok) {
                    allForemen = await response.json();
                    console.log('Foremen loaded from database:', allForemen);
                    
                    // Initial population - show all foremen
                    filterFOSByFacility();
                } else {
                    console.error('Failed to load foremen - HTTP', response.status);
                    fosSelect.innerHTML = '<option value="">Unable to load FOS areas from database</option>';
                }
            } catch (error) {
                console.error('Error loading real foremen:', error);
                document.getElementById('air_fos').innerHTML = '<option value="">Error loading FOS areas</option>';
            }
        }
        
        // Filter FOS options based on selected facility
        function filterFOSByFacility() {
            const facilitySelect = document.getElementById('air_facility');
            const fosSelect = document.getElementById('air_fos');
            const selectedFacility = facilitySelect.value;
            
            console.log('Filtering FOS for facility:', selectedFacility);
            
            // Filter foremen by facility
            let filteredForemen = allForemen;
            if (selectedFacility && selectedFacility !== 'all') {
                filteredForemen = allForemen.filter(fos => fos.facility === selectedFacility);
            }
            
            // Rebuild FOS dropdown
            fosSelect.innerHTML = '<option value="all">All FOS Areas</option>';
            
            if (Array.isArray(filteredForemen)) {
                filteredForemen.forEach(fos => {
                    const option = document.createElement('option');
                    option.value = fos.code;
                    option.textContent = fos.label;
                    fosSelect.appendChild(option);
                });
            }
            
            console.log('FOS options filtered:', filteredForemen.length, 'options');
        }

        // Open air inspection checklist with filters
        function openAirChecklist() {
            const facility = document.getElementById('air_facility').value;
            const fos = document.getElementById('air_fos').value;
            
            if (!facility || !fos) {
                alert('Please select both a Facility and FOS Area');
                return;
            }
            
            console.log('Opening air checklist with filters:', { facility, fos });
            
            // Build query string - only include non-'all' values
            const params = new URLSearchParams();
            
            // Facility: only pass if not 'all'
            if (facility && facility !== 'all' && facility !== '') {
                params.append('facility', facility);
            }
            
            // FOS: only pass if not 'all' (app checks for empty string, so don't pass 'all')
            if (fos && fos !== 'all' && fos !== '') {
                params.append('fos', fos);
            }
            
            // Redirect to the air inspection checklist app
            const appUrl = 'air_inspection_checklist/' + (params.toString() ? '?' + params.toString() : '');
            console.log('Redirecting to:', appUrl);
            window.location.href = appUrl;
        }

        // =====================================================================
        // FOS Overview Dashboard - reuses same facilities/foremen data
        // =====================================================================
        
        // Populate FOS overview dropdowns from already-loaded data
        function populateFOSOverviewDropdowns() {
            const facilitySelect = document.getElementById('fos_facility');
            
            // Copy facilities from the air checklist dropdown
            const airFacilitySelect = document.getElementById('air_facility');
            facilitySelect.innerHTML = '<option value="" disabled selected>Select Facility</option>';
            
            for (let i = 0; i < airFacilitySelect.options.length; i++) {
                const opt = airFacilitySelect.options[i];
                if (opt.value && opt.value !== 'all') {
                    const option = document.createElement('option');
                    option.value = opt.value;
                    option.textContent = opt.textContent;
                    facilitySelect.appendChild(option);
                }
            }
            
            // Initialize FOS dropdown as empty until facility selected
            const fosSelect = document.getElementById('fos_area');
            fosSelect.innerHTML = '<option value="" disabled selected>Select facility first</option>';
        }
        
        // Filter FOS overview areas by selected facility
        function filterFOSOverviewByFacility() {
            const facilitySelect = document.getElementById('fos_facility');
            const fosSelect = document.getElementById('fos_area');
            const selectedFacility = facilitySelect.value;
            
            if (!selectedFacility) {
                fosSelect.innerHTML = '<option value="" disabled selected>Select facility first</option>';
                return;
            }
            
            // Filter foremen by selected facility
            const filteredForemen = allForemen.filter(fos => fos.facility === selectedFacility);
            
            fosSelect.innerHTML = '<option value="" disabled selected>Select FOS Area</option>';
            
            filteredForemen.forEach(fos => {
                const option = document.createElement('option');
                option.value = fos.code;
                option.textContent = fos.label;
                fosSelect.appendChild(option);
            });
        }
        
        // Open FOS Overview Dashboard with selected facility and FOS
        function openFOSOverview() {
            const facility = document.getElementById('fos_facility').value;
            const fos = document.getElementById('fos_area').value;
            
            if (!facility) {
                alert('Please select a Facility');
                return;
            }
            
            if (!fos) {
                alert('Please select a FOS Area');
                return;
            }
            
            // Build URL to overview app with FOS view params
            // Default metrics for FOS view - easily expandable by adding to this list
            const fosMetrics = [
                'catch_basin',
                'drone',
                'ground_prehatch',
                'structure',
                'prehatch_coverage'
            ];
            
            const params = new URLSearchParams();
            params.append('view', 'fos');
            params.append('facility', facility);
            params.append('fos', fos);
            params.append('metric', fosMetrics.join(','));
            
            const appUrl = 'overview/?' + params.toString();
            console.log('Opening FOS Overview:', appUrl);
            window.location.href = appUrl;
        }
    </script>
</body>

</html>
