<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SUCO Analysis Dashboard - Technical Notes</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            line-height: 1.6;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background-color: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1 {
            color: #2c3e50;
            border-bottom: 3px solid #3498db;
            padding-bottom: 10px;
        }
        h2 {
            color: #34495e;
            margin-top: 30px;
            border-bottom: 2px solid #ecf0f1;
            padding-bottom: 8px;
        }
        h3 {
            color: #7f8c8d;
            margin-top: 20px;
        }
        h4 {
            color: #95a5a6;
            margin-top: 15px;
        }
        code {
            background-color: #f8f9fa;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            color: #e74c3c;
        }
        pre {
            background-color: #2c3e50;
            color: #ecf0f1;
            padding: 20px;
            border-radius: 5px;
            overflow-x: auto;
            margin: 15px 0;
            border: 1px solid #34495e;
        }
        pre code {
            background-color: transparent;
            color: #ecf0f1;
            padding: 0;
            border-radius: 0;
            font-size: 0.85em;
        }
        ul, ol {
            margin: 10px 0;
            padding-left: 30px;
        }
        li {
            margin: 5px 0;
        }
        blockquote {
            border-left: 4px solid #3498db;
            background-color: #f8f9fa;
            padding: 10px 20px;
            margin: 20px 0;
            font-style: italic;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }
        th {
            background-color: #f5f5f5;
            font-weight: bold;
        }
        hr {
            border: none;
            height: 2px;
            background-color: #ecf0f1;
            margin: 20px 0;
        }
        p {
            margin: 10px 0;
        }
        a {
            color: #3498db;
            text-decoration: none;
        }
        a:hover {
            text-decoration: underline;
        }
    </style>
    <!-- KaTeX for LaTeX math rendering -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css" integrity="sha384-n8MVd4RsNIU0tAv4ct0nTaAbDJwPJzDEaqSD1odI+WdtXRGWt2kTvGFasHpSy3SV" crossorigin="anonymous">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js" integrity="sha384-XjKyOOlGwcjNTAIQHIpgOno0Hl1YQqzUOEleOLALmuqehneUG+vnGctmUb0ZY0l8" crossorigin="anonymous"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js" integrity="sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05" crossorigin="anonymous"
        onload="renderMathInElement(document.body, {
          delimiters: [
            {left: '$$', right: '$$', display: true},
            {left: '$', right: '$', display: false},
            {left: '\\[', right: '\\]', display: true},
            {left: '\\(', right: '\\)', display: false}
          ]
        });"></script>
</head>
<body>
    <div class="container">
<h1>SUCO Analysis Dashboard - Technical Notes</h1>

<h2>Overview</h2>
<p>This Shiny app provides comprehensive analysis of SUCO inspections across multiple perspectives:</p>
<ol>
<li><strong>Current Data</strong> - Analysis of current year SUCO inspections</li>
<li><strong>All Data (Current + Archive)</strong> - Historical analysis combining current and archived data</li>
</ul>

<p>Each perspective includes:</p>
<ul>
<li><strong>Graph</strong> - Time series visualization of SUCO counts</li>
<li><strong>Map</strong> - Spatial distribution of SUCO locations</li>
<li><strong>Summary Table</strong> - Aggregated statistics by facility/FOS</li>
<li><strong>Detailed Samples</strong> - Individual SUCO inspection records</li>
<li><strong>Top Locations</strong> - Most visited locations or locations with most species</li>
</ul>

<h2>Data Sources</h2>

<h3>Tables Used</h3>

<h4>Primary Inspection Tables</h4>
<ul>
<li><strong><code>dbadult<em>insp</em>current</code></strong> - Active adult surveillance inspection records</li>
<ul>
<li>Contains ongoing inspections for current operations</li>
<li>Fields: <code>id</code>, <code>ainspecnum</code>, <code>facility</code>, <code>foreman</code>, <code>inspdate</code>, <code>sitecode</code>, <code>address1</code>, <code>park_name</code>, <code>survtype</code>, <code>fieldcount</code>, <code>comments</code>, <code>x</code>, <code>y</code>, <code>geometry</code></li>
<li><strong>survtype = '7'</strong> identifies SUCO inspections</li>
<li><strong>NOTE</strong>: Does NOT have <code>enddate</code> column</li>
</ul>
</ul>

<ul>
<li><strong><code>dbadult<em>insp</em>archive</code></strong> - Historical adult surveillance inspection records</li>
<ul>
<li>Contains closed/archived inspections from previous years</li>
<li>Same schema as current table</li>
<li><strong>NOTE</strong>: Does NOT have <code>enddate</code> column</li>
</ul>
</ul>

<h4>Species Tables</h4>
<ul>
<li><strong><code>dbadult<em>species</em>current</code></strong> - Species counts for current inspections</li>
<ul>
<li>Links to inspections via <code>ainspecnum</code></li>
<li>Fields: <code>ainspecnum</code>, <code>spp</code> (species code), <code>cnt</code> (count)</li>
</ul>
</ul>

<ul>
<li><strong><code>dbadult<em>species</em>archive</code></strong> - Species counts for archived inspections</li>
<ul>
<li>Same schema as current species table</li>
</ul>
</ul>

<h4>Supporting Tables</h4>
<ul>
<li><strong><code>loc_harborage</code></strong> - Harborage site lifecycle and assignment tracking</li>
<ul>
<li><strong>AUTHORITATIVE SOURCE</strong> for foreman and facility assignments</li>
<li>Fields: <code>sitecode</code>, <code>facility</code>, <code>foreman</code>, <code>startdate</code>, <code>enddate</code></li>
<li>Used to determine which FOS/facility was responsible at time of inspection</li>
<li><strong>Join logic</strong>: <code>s.inspdate &gt;= h.startdate AND (h.enddate IS NULL OR s.inspdate &lt;= h.enddate)</code></li>
</ul>
</ul>

<ul>
<li><strong><code>gis_sectcode</code></strong> - Section/zone information</li>
<ul>
<li>Links site codes to geographic zones (P1 = zone '1', P2 = zone '2')</li>
<li>Fields: <code>sectcode</code>, <code>facility</code>, <code>fosarea</code>, <code>zone</code></li>
<li><strong>Fallback</strong> for facility if harborage doesn't have data</li>
<li>Join pattern:</li>
</ul>
</ul>
<p>    ```sql</p>
<p>    LEFT JOIN public.gis_sectcode g ON LEFT(s.sitecode, 6) || '-' = g.sectcode</p>
<p>      OR LEFT(s.sitecode, 6) || 'N' = g.sectcode</p>
<p>      OR LEFT(s.sitecode, 6) || 'S' = g.sectcode</p>
<p>      OR LEFT(s.sitecode, 6) || 'E' = g.sectcode</p>
<p>      OR LEFT(s.sitecode, 6) || 'W' = g.sectcode</p>
<p>    ```</p>

<ul>
<li><strong><code>lookup_specieslist</code></strong> - Species name lookup</li>
<ul>
<li>Maps species codes to genus and species names</li>
<li>Fields: <code>sppcode</code>, <code>genus</code>, <code>species</code></li>
</ul>
</ul>

<h3>Survtype Codes</h3>
<ul>
<li><strong>survtype '7'</strong> - SUCO inspections (this is the focus of the app)</li>
<li>Other survtypes are filtered out</li>
</ul>

<h3>Data Hierarchy and Fallback Logic</h3>

<p>The app uses a cascading fallback approach for facility and foreman assignment:</p>

<pre><code class="sql">
-- Facility assignment (in order of preference):
COALESCE(h.facility, g.facility, s.facility) as facility

-- Foreman assignment (in order of preference):
COALESCE(h.foreman, s.foreman) as foreman
</code></pre>

<p><strong>Why this hierarchy?</strong></p>
<ol>
<li><strong><code>loc_harborage</code></strong> is the most accurate source for practical assignments</li>
<li><strong><code>gis_sectcode</code></strong> provides geographic-based facility assignment</li>
<li><strong>Original inspection data</strong> (<code>s.facility</code>, <code>s.foreman</code>) is the final fallback</li>
</ul>

<h2>Query Patterns</h2>

<h3>Current Data Query Pattern</h3>
<pre><code class="sql">
SELECT
  s.id, s.ainspecnum, 
  COALESCE(h.facility, g.facility, s.facility) as facility,
  COALESCE(h.foreman, s.foreman) as foreman,
  s.inspdate, s.sitecode,
  s.address1, s.park_name, s.survtype, s.fieldcount, s.comments,
  s.x, s.y,
  g.zone
FROM public.dbadult_insp_current s
LEFT JOIN public.loc_harborage h ON s.sitecode = h.sitecode
  AND s.inspdate &gt;= h.startdate 
  AND (h.enddate IS NULL OR s.inspdate &lt;= h.enddate)
LEFT JOIN public.gis_sectcode g ON LEFT(s.sitecode, 6) || '-' = g.sectcode
  OR LEFT(s.sitecode, 6) || 'N' = g.sectcode
  OR LEFT(s.sitecode, 6) || 'S' = g.sectcode
  OR LEFT(s.sitecode, 6) || 'E' = g.sectcode
  OR LEFT(s.sitecode, 6) || 'W' = g.sectcode
WHERE s.survtype = '7'
  AND s.inspdate BETWEEN [start_date] AND [end_date]
</code></pre>

<h3>All Data Query Pattern</h3>
<p>Same as current data query, but queries both <code>dbadult<em>insp</em>current</code> and <code>dbadult<em>insp</em>archive</code>, then combines with <code>bind_rows()</code>.</p>

<h3>Species Data Integration</h3>
<p>After retrieving inspection data:</p>
<ol>
<li>Query species tables for all <code>ainspecnum</code> values</li>
<li>Join with <code>lookup_specieslist</code> for species names</li>
<li>Use enhanced species mapping from <code>db_helpers.R</code></li>
<li>Create species summary for each SUCO inspection</li>
</ul>

<h2>Key Features</h2>

<h3>Date Controls</h3>

<h4>Date Shortcut Buttons</h4>
<ul>
<li><strong>This Year</strong> - Sets date range to Jan 1 of current year through today</li>
<li><strong>This Month</strong> - Sets date range to first day of current month through today</li>
<li><strong>This Week</strong> - Sets date range to Monday of current week through today</li>
</ul>

<h4>Year Range Slider (All Data Tab Only)</h4>
<ul>
<li>Allows multi-year selection for historical analysis</li>
<li>Min: 2015, Max: Current year</li>
<li>Automatically syncs with custom date range</li>
</ul>

<h4>Custom Date Range</h4>
<ul>
<li>Allows precise date selection</li>
<li>Behavior depends on active tab:</li>
<ul>
<li><strong>Current Data Tab</strong>: Restricted to current year only</li>
<li><strong>All Data Tab</strong>: Full date range available</li>
</ul>
</ul>

<h3>Grouping Options</h3>

<h4>MMCD (All)</h4>
<ul>
<li>Aggregates all SUCOs across entire organization</li>
<li>No facility or FOS breakdown</li>
</ul>

<h4>Facility</h4>
<ul>
<li>Groups by facility assignment</li>
<li>Uses facility colors from <code>db_helpers.R</code></li>
<li>Shows facility full names in displays</li>
</ul>

<h4>FOS (Field Operations Supervisor)</h4>
<ul>
<li>Groups by foreman assignment</li>
<li>Uses foreman colors from <code>db_helpers.R</code> (facility-based)</li>
<li>Shows foreman short names in displays</li>
</ul>

<h3>Filter Options</h3>

<h4>Zone Filter</h4>
<ul>
<li><strong>P1 + P2</strong> - Both zones combined</li>
<li><strong>P1</strong> - Primary zone only (zone = '1')</li>
<li><strong>P2</strong> - Secondary zone only (zone = '2')</li>
</ul>

<h4>Facility Filter</h4>
<ul>
<li>Multi-select dropdown</li>
<li>Populated from <code>get<em>facility</em>lookup()</code></li>
<li>"All" option includes all facilities</li>
</ul>

<h4>FOS Filter</h4>
<ul>
<li>Multi-select dropdown</li>
<li>Dynamically populated based on selected facility</li>
<li>Shows foreman short names</li>
<li>"All" option includes all foremen</li>
</ul>

<h4>Species Filter</h4>
<ul>
<li>Single-select dropdown</li>
<li>Dynamically populated from available species in date range</li>
<li>Uses enhanced species mapping for display names</li>
<li>Filters SUCOs to only those containing the selected species</li>
</ul>

<h3>Graph Types</h3>

<p>The app supports multiple visualization types:</p>
<ul>
<li><strong>Bar</strong> - Side-by-side bars</li>
<li><strong>Stacked Bar</strong> - Stacked bars (default)</li>
<li><strong>Line</strong> - Line chart</li>
<li><strong>Point</strong> - Scatter plot</li>
<li><strong>Area</strong> - Filled area chart</li>
</ul>

<h3>Top Locations Display Modes</h3>

<h4>Most Visited</h4>
<ul>
<li>Shows locations with most SUCO samples</li>
<li>Each segment represents one SUCO sample</li>
<li>Colors indicate sample date (gradient from old to new)</li>
</ul>

<h4>Most Species</h4>
<ul>
<li>Shows locations with highest species counts</li>
<li>Each segment represents one SUCO sample</li>
<li>Colors indicate sample date (gradient from old to new)</li>
<li>Can be filtered to specific species</li>
</ul>

<h2>Tab 1: Graph</h2>

<h3>Purpose</h3>
<p>Visualize SUCO inspection trends over time, grouped by facility, FOS, or all MMCD.</p>

<h3>Key Features</h3>
<ul>
<li><strong>Time Interval</strong>: Weekly (Monday start date)</li>
<li><strong>Average Line</strong> (All Data tab only): Shows average SUCOs per week across entire date range</li>
<li><strong>Year Boundaries</strong>: Vertical lines separate different years</li>
<li><strong>Epi Week Labels</strong>: X-axis uses epidemiological week numbers</li>
</ul>

<h3>Calculation Logic</h3>

<h4>Step 1: Aggregate by Time Group</h4>
<pre><code class="r">
data %&gt;%
  mutate(time_group = week_start) %&gt;%  # Monday of each week
  group_by(time_group, [group_by_column]) %&gt;%
  summarize(
    count = n(),
    total_fieldcount = sum(fieldcount, na.rm = TRUE),
    epi_week_label = first(epi_week_label),
    .groups = "drop"
  )
</code></pre>

<h4>Step 2: Create Plot with Color Mapping</h4>
<ul>
<li><strong>Facility grouping</strong>: Uses <code>get<em>facility</em>base_colors()</code></li>
<li><strong>FOS grouping</strong>: Maps foreman numbers to facility-based colors via <code>get<em>foreman</em>colors()</code></li>
<li><strong>MMCD grouping</strong>: Single blue color</li>
</ul>

<h4>Step 3: Add Average Line (All Data Only)</h4>
<pre><code class="r">
# Calculate total SUCOs per week (across all groups)
weekly_totals &lt;- data %&gt;%
  group_by(time_group) %&gt;%
  summarize(total_count = sum(count, na.rm = TRUE))

avg_sucos_per_week &lt;- mean(weekly_totals$total_count, na.rm = TRUE)

# Add horizontal line at average
geom_hline(yintercept = avg_sucos_per_week, color = "red", linetype = "dashed")
</code></pre>

<h2>Tab 2: Map</h2>

<h3>Purpose</h3>
<p>Display spatial distribution of SUCO inspections with interactive markers.</p>

<h3>Marker Sizing Logic</h3>
<p>Markers are sized based on species count using a staged approach:</p>

<pre><code class="r">
marker_size = case_when(
  display_species_count == 0 ~ 4,      # No species
  display_species_count == 1 ~ 6,      # 1 species
  display_species_count &lt;= 5 ~ 8,      # 2-5 species
  display_species_count &lt;= 10 ~ 10,    # 6-10 species
  display_species_count &lt;= 20 ~ 12,    # 11-20 species
  display_species_count &lt;= 30 ~ 14,    # 21-30 species
  display_species_count &lt;= 50 ~ 16,    # 31-50 species
  display_species_count &lt;= 75 ~ 18,    # 51-75 species
  display_species_count &lt;= 100 ~ 20,   # 76-100 species
  TRUE ~ 22                             # 100+ species
)
</code></pre>

<h3>Overlapping Point Handling</h3>
<p>When multiple SUCOs occur at the same location:</p>
<pre><code class="r">
# Add small random offset (max 0.0001 degrees ≈ 11 meters)
longitude_adj = longitude + runif(n(), -0.0001, 0.0001)
latitude_adj = latitude + runif(n(), -0.0001, 0.0001)
</code></pre>

<h3>Color Schemes</h3>

<h4>Facility Map</h4>
<ul>
<li>Uses <code>get<em>facility</em>base<em>colors()</code> from <code>db</em>helpers.R</code></li>
<li>Each facility has a distinct color</li>
<li>Legend shows facility full names</li>
</ul>

<h4>FOS Map</h4>
<ul>
<li>Uses <code>get<em>foreman</em>colors()</code> from <code>db_helpers.R</code></li>
<li>Colors are facility-based (same facility = similar color shades)</li>
<li>Legend ordered by facility, then foreman</li>
<li>Shows foreman short names</li>
</ul>

<h4>MMCD Map</h4>
<ul>
<li>Single blue color (<code>#1f77b4</code>)</li>
<li>No facility/FOS differentiation</li>
</ul>

<h3>Popup Content</h3>
<pre><code class="">
Date: [inspdate]
Facility: [facility full name]
FOS: [foreman short name]
Location: [location]
Species Count: [display_species_count]
Species Found:
  [species_name]: [count]
  [species_name]: [count]
  ...
</code></pre>

<h3>Basemap Options</h3>
<ul>
<li><strong>OpenStreetMap</strong> - Standard OSM tiles</li>
<li><strong>Carto Light</strong> - Clean, minimal basemap (default)</li>
<li><strong>Terrain</strong> - Topographic map</li>
<li><strong>Esri Satellite</strong> - Satellite imagery</li>
</ul>

<h2>Tab 3: Summary Table</h2>

<h3>Purpose</h3>
<p>Provide aggregated statistics grouped by facility or FOS.</p>

<h3>Columns</h3>

<h4>MMCD (All) Grouping</h4>
<p>| Column | Description |</p>
<p>|--------|-------------|</p>
<p>| Total_SUCOs | Total number of SUCO inspections |</p>
<p>| Total_Locations | Count of unique sitecodes |</p>
<p>| Total<em>Species</em>Count | Sum of all species counts |</p>
<p>| First_SUCO | Earliest inspection date |</p>
<p>| Last_SUCO | Most recent inspection date |</p>

<h4>Facility Grouping</h4>
<p>| Column | Description |</p>
<p>|--------|-------------|</p>
<p>| Facility | Facility short code |</p>
<p>| Facility_Name | Facility full name |</p>
<p>| Total_SUCOs | Total SUCO inspections |</p>
<p>| Total_Locations | Unique locations |</p>
<p>| Total<em>Species</em>Count | Sum of species counts |</p>
<p>| First_SUCO | Earliest inspection |</p>
<p>| Last_SUCO | Most recent inspection |</p>

<h4>FOS Grouping</h4>
<p>| Column | Description |</p>
<p>|--------|-------------|</p>
<p>| FOS | Foreman employee number |</p>
<p>| Name | Foreman short name |</p>
<p>| Facility | Assigned facility |</p>
<p>| Total_SUCOs | Total SUCO inspections |</p>
<p>| Total_Locations | Unique locations |</p>
<p>| Total<em>Species</em>Count | Sum of species counts |</p>
<p>| First_SUCO | Earliest inspection |</p>
<p>| Last_SUCO | Most recent inspection |</p>

<h3>Key Features</h3>
<ul>
<li><strong>Includes zeros</strong>: Shows all facilities/foremen even with 0 SUCOs in selected date range</li>
<li><strong>Sorted by activity</strong>: Ordered by Total_SUCOs descending</li>
<li><strong>Searchable</strong>: Built-in search functionality</li>
<li><strong>Paginated</strong>: 15 rows per page</li>
</ul>

<h2>Tab 4: Detailed Samples</h2>

<h3>Purpose</h3>
<p>Show individual SUCO inspection records with full details.</p>

<h3>Columns</h3>
<ul>
<li><strong>Date</strong> - Inspection date</li>
<li><strong>Facility</strong> - Facility full name</li>
<li><strong>FOS</strong> - Foreman short name</li>
<li><strong>Zone</strong> - P1 or P2</li>
<li><strong>Sitecode</strong> - Site identifier</li>
<li><strong>Location</strong> - Park name or address</li>
<li><strong>Species_Count</strong> - Total count (or filtered species count)</li>
<li><strong>Species_Found</strong> - Semicolon-separated species list with counts</li>
</ul>

<h3>Filtering Behavior</h3>
<p>When a species filter is applied:</p>
<ul>
<li>Only shows SUCOs containing that species</li>
<li>Species_Count shows count of filtered species only</li>
<li>Sorted by Species_Count descending</li>
</ul>

<h3>Display Features</h3>
<ul>
<li><strong>Scrollable</strong>: Horizontal scroll for wide content</li>
<li><strong>Searchable</strong>: Can search across all columns</li>
<li><strong>Paginated</strong>: 25 rows per page</li>
<li><strong>Truncated species list</strong>: Long species lists are abbreviated with "..."</li>
</ul>

<h2>Tab 5: Top Locations</h2>

<h3>Purpose</h3>
<p>Identify and visualize locations with most SUCO activity or highest species diversity.</p>

<h3>Display Modes</h3>

<h4>Most Visited</h4>
<ul>
<li>Shows top 25 locations by number of SUCO samples</li>
<li>Each horizontal segment = one SUCO sample</li>
<li>Color gradient = sample date (older → darker, newer → lighter)</li>
<li>Y-axis label: "Individual Samples"</li>
</ul>

<h4>Most Species</h4>
<ul>
<li>Shows top 25 locations by total species count</li>
<li>Each horizontal segment = one SUCO sample with species count</li>
<li>Color gradient = sample date</li>
<li>Y-axis label: "Species Count per Sample"</li>
<li>When species filter applied: shows count of that specific species</li>
</ul>

<h3>Interactive Features</h3>
<ul>
<li><strong>Click to map</strong>: Clicking a bar switches to Map tab and zooms to that location</li>
<li><strong>Hover details</strong>: Shows date, location, and species found</li>
<li><strong>Stacked bars</strong>: Multiple samples at same location stack vertically</li>
</ul>

<h3>Sample Coloring</h3>
<p>Uses viridis color scale for date gradient:</p>
<pre><code class="r">
fill = date_numeric  # Continuous numeric date value
scale_fill_viridis_c(option = "viridis", name = "Date")
</code></pre>

<h2>Code Organization</h2>

<h3>File Structure</h3>
<pre><code class="">
suco_history/
├── app.R                    # Main UI and server logic
├── data_functions.R         # Database queries and data processing
├── display_functions.R      # Visualization functions
└── ui_helpers.R             # UI interaction handlers
</code></pre>

<h3>Design Principles</h3>
<ol>
<li><strong>Separation of Concerns</strong>: UI/server in <code>app.R</code>, all SQL in <code>data_functions.R</code></li>
<li><strong>No SQL in app.R</strong>: Every query wrapped in a function</li>
<li><strong>Reusable Components</strong>: Same map/plot/table functions for both current and all data</li>
<li><strong>Consistent Patterns</strong>: Parallel structure for current and all data tabs</li>
</ul>

<h3>Function Files</h3>

<h4>data_functions.R</h4>
<p>Core data retrieval and processing:</p>
<ul>
<li><code>get<em>available</em>species(date_range)</code> - Populate species filter dropdown</li>
<li><code>get<em>suco</em>data(data<em>source, date</em>range)</code> - Main data query function</li>
<li><code>filter<em>suco</em>data(data, ...)</code> - Apply user filters</li>
<li><code>create<em>spatial</em>data(data, species_filter)</code> - Prepare data for mapping</li>
<li><code>aggregate<em>suco</em>data(data, group<em>by, zone</em>filter)</code> - Time series aggregation</li>
<li><code>create<em>summary</em>stats(data, group<em>by, data</em>source)</code> - Summary table data</li>
<li><code>get<em>top</em>locations(data, mode, species_filter)</code> - Top locations data</li>
<li><code>create<em>detailed</em>samples<em>table(data, species</em>filter)</code> - Detailed table data</li>
</ul>

<h4>display_functions.R</h4>
<p>Visualization rendering:</p>
<ul>
<li><code>create<em>suco</em>map(data, input, data_source)</code> - Leaflet map creation</li>
<li><code>create<em>location</em>plotly(data, data_source, mode)</code> - Top locations chart</li>
<li><code>create<em>trend</em>plot(aggregated_data, ...)</code> - Time series plot</li>
<li><code>convert<em>zone</em>selection(zone_input)</code> - Helper for zone filtering</li>
</ul>

<h4>ui_helpers.R</h4>
<p>UI interaction handlers:</p>
<ul>
<li><code>handle<em>date</em>shortcut(shortcut_type, ...)</code> - Date button handlers</li>
<li><code>handle<em>year</em>range_change(...)</code> - Year slider updates</li>
<li><code>handle<em>date</em>range_change(...)</code> - Date picker updates</li>
<li><code>set<em>updating</em>flags(...)</code> - Prevent infinite update loops</li>
</ul>

<h3>Shared Utilities (shared/db_helpers.R)</h3>
<ul>
<li><code>get<em>db</em>connection()</code> - Database connection helper</li>
<li><code>get<em>facility</em>lookup()</code> - Facility codes and full names</li>
<li><code>get<em>foremen</em>lookup()</code> - Foreman numbers, names, and facilities</li>
<li><code>get<em>facility</em>base_colors()</code> - Color mapping for facilities</li>
<li><code>get<em>foreman</em>colors()</code> - Color mapping for foremen (facility-based)</li>
<li><code>get<em>species</em>lookup()</code> - Species code to name mapping</li>
<li><code>get<em>enhanced</em>species_mapping()</code> - Enhanced species display names</li>
</ul>

<h2>Common Data Patterns</h2>

<h3>Species Summary Creation</h3>
<p>For each SUCO inspection (<code>ainspecnum</code>):</p>
<ol>
<li>Join inspection with species tables</li>
<li>Join species codes with lookup table</li>
<li>Apply enhanced species mapping</li>
<li>Aggregate species by name and count</li>
<li>Format as HTML for popups:</li>
</ul>
<p>   ```</p>
<p>   Species Name 1: 50</p>
<p>   Species Name 2: 32</p>
<p>   Species Name 3: 15</p>
<p>   Others: 25</p>
<p>   ```</p>
<ol>
<li>Limit to top 5 species to keep popups manageable</li>
</ul>

<hr>

<p><em>Last updated: November 2025</em></p>
    </div>
</body>
</html>
