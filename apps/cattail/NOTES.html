<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cattail Inspection Progress - Technical Notes</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            line-height: 1.6;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background-color: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1 {
            color: #2c3e50;
            border-bottom: 3px solid #3498db;
            padding-bottom: 10px;
        }
        h2 {
            color: #34495e;
            margin-top: 30px;
            border-bottom: 2px solid #ecf0f1;
            padding-bottom: 8px;
        }
        h3 {
            color: #7f8c8d;
            margin-top: 20px;
        }
        h4 {
            color: #95a5a6;
            margin-top: 15px;
        }
        code {
            background-color: #f8f9fa;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            color: #e74c3c;
        }
        pre {
            background-color: #2c3e50;
            color: #ecf0f1;
            padding: 20px;
            border-radius: 5px;
            overflow-x: auto;
            margin: 15px 0;
            border: 1px solid #34495e;
        }
        pre code {
            background-color: transparent;
            color: #ecf0f1;
            padding: 0;
            border-radius: 0;
            font-size: 0.85em;
        }
        ul, ol {
            margin: 10px 0;
            padding-left: 30px;
        }
        li {
            margin: 5px 0;
        }
        blockquote {
            border-left: 4px solid #3498db;
            background-color: #f8f9fa;
            padding: 10px 20px;
            margin: 20px 0;
            font-style: italic;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }
        th {
            background-color: #f5f5f5;
            font-weight: bold;
        }
        hr {
            border: none;
            height: 2px;
            background-color: #ecf0f1;
            margin: 20px 0;
        }
        p {
            margin: 10px 0;
        }
        a {
            color: #3498db;
            text-decoration: none;
        }
        a:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <div class="container">
<h1>Cattail Inspection Progress - Technical Notes</h1>

<h2>Overview</h2>
<p>This Shiny app tracks cattail larval mosquito inspection progress across three perspectives:</p>
<ol>
<li><strong>Progress vs Goal</strong> - Current year actual inspections compared to facility-specific goals</li>
<li><strong>Historical Comparison</strong> - Current year performance vs previous years' baseline</li>
<li><strong>Treatment Planning</strong> - Planned treatments by facility and plan type</li>
</ul>

<h2>Data Sources</h2>

<h3>Tables Used</h3>

<h4>Primary Inspection Tables</h4>
<ul>
<li><strong><code>dblarv<em>insptrt</em>current</code></strong> - Active larval inspection records</li>
<ul>
<li>Contains ongoing inspections for current operations</li>
<li>Fields: <code>sitecode</code>, <code>facility</code>, <code>action</code>, <code>inspdate</code>, <code>reinspect</code>, <code>wet</code>, <code>numdip</code>, <code>acres</code>, <code>acres_plan</code></li>
<li><strong>NOTE</strong>: Does NOT have <code>enddate</code> column</li>
</ul>
</ul>

<ul>
<li><strong><code>dblarv<em>insptrt</em>archive</code></strong> - Historical larval inspection records</li>
<ul>
<li>Contains closed/archived inspections from previous years</li>
<li>Same schema as current table</li>
<li>Fields: <code>sitecode</code>, <code>facility</code>, <code>action</code>, <code>inspdate</code>, <code>reinspect</code>, <code>wet</code>, <code>numdip</code>, <code>acres</code>, <code>acres_plan</code></li>
<li><strong>NOTE</strong>: Does NOT have <code>enddate</code> column</li>
</ul>
</ul>

<h4>Supporting Tables</h4>
<ul>
<li><strong><code>loc<em>breeding</em>sites</code></strong> - Site lifecycle tracking</li>
<ul>
<li><strong>CRITICAL</strong>: This is the ONLY table with <code>enddate</code> column</li>
<li>Tracks when sites are opened and closed</li>
<li><strong>CAN HAVE MULTIPLE ROWS PER SITECODE</strong> with different enddates</li>
<li>Used to filter out sites that no longer exist</li>
</ul>
</ul>

<ul>
<li><strong><code>gis_sectcode</code></strong> - Section/zone information</li>
<ul>
<li>Links site codes to geographic zones (P1 = zone '1', P2 = zone '2')</li>
<li>Join pattern: </li>
</ul>
</ul>
<p>    ```sql</p>
<p>    LEFT JOIN public.gis_sectcode g ON LEFT(a.sitecode, 6) || '-' = g.sectcode</p>
<p>      OR LEFT(a.sitecode, 6) || 'N' = g.sectcode</p>
<p>      OR LEFT(a.sitecode, 6) || 'S' = g.sectcode</p>
<p>      OR LEFT(a.sitecode, 6) || 'E' = g.sectcode</p>
<p>      OR LEFT(a.sitecode, 6) || 'W' = g.sectcode</p>
<p>    ```</p>
<ul>
<li>Note: Some sitecodes use directional suffixes (N, S, E, W) instead of '-'</li>
</ul>
</ul>

<ul>
<li><strong><code>cattail<em>pctcomplete</em>base</code></strong> - Goal/target data</li>
<ul>
<li>Contains facility-specific goals for P1 and P2 zones</li>
<li>Fields: <code>facility</code>, <code>p1<em>totsitecount</code>, <code>p2</em>totsitecount</code></li>
<li><strong>ONLY USED FOR PROGRESS VS GOAL TAB</strong> - not for historical comparison</li>
</ul>
</ul>

<h3>Action Codes</h3>
<ul>
<li><strong>Action '9'</strong> - Cattail inspections (this is the focus of the app)</li>
<li>Other actions are filtered out</li>
</ul>

<h3>Data Fields for Action '9' Records</h3>
<ul>
<li><strong><code>sitecode</code></strong> - Unique site identifier</li>
<li><strong><code>facility</code></strong> - Facility responsible for the inspection</li>
<li><strong><code>inspdate</code></strong> - Date of inspection </li>
<li><strong><code>wet</code></strong> - Whether the site was wet during inspection</li>
<li><strong><code>numdip</code></strong> - Number of dips taken during inspection (MUST be non-zero for action='9')</li>
<li><strong><code>acres</code></strong> - Site acres treated</li>
<li><strong><code>acres_plan</code></strong> - Planned acres for treatment</li>
<li><strong><code>reinspect</code></strong> - Flag indicating if this is a re-inspection</li>
</ul>

<h3>Reinspect Flag</h3>
<ul>
<li><strong>reinspect IS NULL OR reinspect = 'f'</strong> - First inspection (counted)</li>
<li><strong>reinspect = 't'</strong> - Re-inspection (excluded to avoid double-counting)</li>
</ul>

<h2>Critical Data Integrity Issue: Site Enddate Filtering</h2>

<h3>The Problem</h3>
<p><strong>Inspection tables do NOT have enddate columns.</strong> Sites that have been closed (enddate in past) can still have records in inspection tables, which would incorrectly inflate counts.</p>

<h3>The Solution</h3>
<p><strong>ALWAYS join with <code>loc<em>breeding</em>sites</code> and filter by enddate:</strong></p>

<pre><code class="sql">
LEFT JOIN public.loc_breeding_sites b ON a.sitecode = b.sitecode
WHERE (b.enddate IS NULL OR b.enddate &gt; CURRENT_DATE)
</code></pre>

<h3>Why This Matters</h3>
<ul>
<li>Site <code>190208-003</code> had 11 rows in <code>loc<em>breeding</em>sites</code>, ALL with past enddates</li>
<li>Without the join, inspections from 2019-2023 appeared in results</li>
<li>This caused "ghost sites" to appear in historical data</li>
<li><strong>EVERY query that counts sites MUST include this filter</strong></li>
</ul>

<h3>Which Queries Need This Filter?</h3>
<p> <strong>Historical Comparison queries</strong> - Archive AND Current tables (both historical and current year queries)</p>
<p> <strong>Sites table queries</strong> - Any query showing site details</p>

<p> <strong>Progress vs Goal queries</strong> - These are year-specific and don't need active site filtering (the goal is based on that year's operation)</p>


<h3>SQL Query Pattern for Site Details</h3>
<pre><code class="sql">
-- Example: Get site details including required numdip
SELECT 
  a.sitecode,
  a.facility, 
  a.inspdate,
  a.wet,
  a.numdip,    --  for action='9'
  a.acres,
  a.acres_plan
FROM public.dblarv_insptrt_current a
LEFT JOIN public.loc_breeding_sites b ON a.sitecode = b.sitecode  
WHERE a.action = '9'
  AND (a.reinspect IS NULL OR a.reinspect = 'f')
  AND (b.enddate IS NULL OR b.enddate &gt; CURRENT_DATE)
  AND a.numdip &gt; 0  -- Ensure valid dip count
</code></pre>

<h2>Tab 1: Progress vs Goal</h2>

<h3>Purpose</h3>
<p>Compare actual unique site inspections to facility-specific goals for the selected year and zone.</p>

<h3>Key Features</h3>
<ul>
<li><strong>Year selector</strong> - Choose year to analyze (defaults to current year)</li>
<li><strong>Goal Type selector</strong> - P1 (Primary Goal) or P2 (Secondary Goal)</li>
<li><strong>Custom Date slider</strong> - Analyze progress "as of" a specific date in the year</li>
</ul>

<h3>Data Flow</h3>
<ol>
<li>Query <code>dblarv<em>insptrt</em>archive</code> and <code>dblarv<em>insptrt</em>current</code> for:</li>
<ul>
<li>Action = '9' (cattail)</li>
<li>Selected year</li>
<li>Inspections on or before custom date</li>
<li>Exclude reinspects</li>
</ul>
</ul>

<ol>
<li>Join with <code>gis_sectcode</code> to get zone information</li>
</ul>

<ol>
<li>Group by facility and zone, COUNT total inspections</li>
</ul>

<ol>
<li>Query <code>cattail<em>pctcomplete</em>base</code> for goals (p1<em>totsitecount or p2</em>totsitecount)</li>
</ul>

<ol>
<li>Filter to selected zone only (zone '1' for P1, zone '2' for P2)</li>
</ul>

<ol>
<li>Create side-by-side bar chart:</li>
<ul>
<li>Green bars: Actual inspections</li>
<li>Gray bars: Goal</li>
</ul>
</ul>

<h3>SQL Query Pattern</h3>
<pre><code class="sql">
-- Get actuals from archive
SELECT a.facility, g.zone, COUNT(*) AS inspections
FROM public.dblarv_insptrt_archive a
LEFT JOIN public.gis_sectcode g ON LEFT(a.sitecode, ...) = LEFT(g.sectcode, ...)
WHERE a.action = '9'
  AND EXTRACT(YEAR FROM a.inspdate) = [year]
  AND a.inspdate &lt;= '[custom_date]'
  AND (a.reinspect IS NULL OR a.reinspect = 'f')
GROUP BY a.facility, g.zone

-- Combine with current
UNION with same query on dblarv_insptrt_current

-- Get goals
SELECT facility, p1_totsitecount, p2_totsitecount 
FROM public.cattail_pctcomplete_base
</code></pre>

<p><strong>NOTE</strong>: No <code>loc<em>breeding</em>sites</code> join needed here because we're measuring year-specific operational progress, not active site status.</p>

<h2>Tab 2: Historical Comparison</h2>

<h3>Purpose</h3>
<p>Compare current year's unique site inspections to a historical baseline (average of previous X years) by zone.</p>

<h3>Key Features</h3>
<ul>
<li><strong>Zone selector</strong> - P1 (Zone 1) or P2 (Zone 2)</li>
<ul>
<li><strong>IMPORTANT</strong>: This is NOT "goal type" - it's just zone filtering</li>
<li>The goal table is NOT used in this tab at all</li>
</ul>
<li><strong>Previous X years slider</strong> - Number of historical years to compare (1-10, default 3)</li>
<li><strong>Facility filter</strong> - Multi-select to focus on specific facilities or all</li>
<li><strong>Sites table view toggle</strong>:</li>
<ul>
<li>"All sites in last X years" - Show all sites inspected historically</li>
<li>"Sites NOT checked this year" - Show sites needing attention</li>
</ul>
</ul>

<h3>Site Inspection Details Table</h3>
<p>The sites table shows detailed information for each site including:</p>
<ul>
<li><strong>Site Code</strong> - Unique identifier</li>
<li><strong>Facility</strong> - Responsible facility</li>
<li><strong>Last Inspection</strong> - Date of most recent inspection</li>
<li><strong>Wet</strong> - Whether site was wet during last inspection  </li>
<li><strong>Num Dip</strong> - Number of dips taken (must be &gt;0 for valid action='9' records)</li>
<li><strong>Acres</strong> - Site acres</li>
<li><strong>Acres Plan</strong> - Planned treatment acres</li>
</ul>

<p><strong>Key SQL Elements:</strong></p>
<ul>
<li>Uses <code>ROW_NUMBER() OVER (PARTITION BY sitecode, facility ORDER BY inspdate DESC)</code> to get most recent inspection per site</li>
<li>Includes <code>numdip</code> field to show inspection completeness</li>
<li>Filters for valid inspections: <code>action='9'</code>, non-reinspects, active sites only</li>
</ul>

<h3>Historical Baseline Calculation</h3>
<p><strong>Historical Baseline</strong> = ALL unique sites inspected in years [current<em>year - X] through [current</em>year - 1]</p>

<p>Example (current year = 2025, X = 3):</p>
<ul>
<li>Historical range: 2022, 2023, 2024 (excludes 2025)</li>
<li>Query finds ALL unique sites inspected across those 3 years COMBINED</li>
<li>This is a <strong>TOTAL COMBINED COUNT</strong>, not an average</li>
<li>If a site was inspected in 2022, 2023, and 2024, it's counted once</li>
<li>If a site was only inspected in 2023, it's counted once</li>
</ul>

<p><strong>Current Year</strong> = Unique sites inspected in 2025</p>

<p><strong>Important</strong>: This shows TOTAL unique sites over X years, NOT the average per year.</p>

<h3>Data Flow</h3>

<h4>Graph Query</h4>
<ol>
<li>Query for <strong>Historical Baseline</strong>:</li>
</ul>
<p>   ```sql</p>
<p>   WHERE EXTRACT(YEAR FROM a.inspdate) &gt;= [current_year - X]</p>
<p>     AND EXTRACT(YEAR FROM a.inspdate) &lt;= [current_year - 1]</p>
<p>     AND g.zone = '[selected_zone]'</p>
<p>     AND (b.enddate IS NULL OR b.enddate &gt; CURRENT_DATE)  -- Critical!</p>
<p>   ```</p>
<ul>
<li>Combines archive + current tables with UNION ALL</li>
<li>Joins with <code>gis_sectcode</code> for zone filtering</li>
<li><strong>Joins with <code>loc<em>breeding</em>sites</code> to exclude ended sites</strong></li>
<li>Groups by facility</li>
<li>Uses <code>COUNT(DISTINCT sitecode)</code> to avoid duplicates</li>
</ul>
</ul>

<ol>
<li>Query for <strong>Current Year</strong>:</li>
</ul>
<p>   ```sql</p>
<p>   WHERE EXTRACT(YEAR FROM a.inspdate) = [current_year]</p>
<p>     AND g.zone = '[selected_zone]'</p>
<p>     AND (b.enddate IS NULL OR b.enddate &gt; CURRENT_DATE)  -- Critical!</p>
<p>   ```</p>
<ul>
<li>Same structure as historical query</li>
<li>Only difference: single year filter</li>
</ul>
</ul>

<ol>
<li>Combine results with type labels:</li>
<ul>
<li>Historical results get <code>type = "Historical Baseline"</code></li>
<li>Current results get <code>type = "Current Year"</code></li>
</ul>
</ul>

<ol>
<li>Plot as side-by-side bars:</li>
<ul>
<li>Gray bars: Historical Baseline</li>
<li>Green bars: Current Year</li>
<li>Legend at top shows which is which</li>
</ul>
</ul>

<h4>Sites Table Query</h4>

<p><strong>Two modes based on <code>sites<em>view</em>type</code>:</strong></p>

<h5>Mode 1: "All sites in last X years"</h5>
<p>Shows every unique site inspected in the historical range, with details about when it was last inspected.</p>

<pre><code class="sql">
WITH ranked_inspections AS (
  SELECT 
    a.sitecode,
    a.facility,
    a.inspdate,
    a.wet,
    a.numdip,     -- Number of dips (must be &gt;0 for action='9')
    a.acres,
    a.acres_plan,
    g.zone,
    ROW_NUMBER() OVER (PARTITION BY a.sitecode, a.facility ORDER BY a.inspdate DESC) as rn
  FROM public.dblarv_insptrt_current a
  LEFT JOIN public.gis_sectcode g ON LEFT(a.sitecode, 6) || '-' = g.sectcode
    OR LEFT(a.sitecode, 6) || 'N' = g.sectcode
    OR LEFT(a.sitecode, 6) || 'S' = g.sectcode
    OR LEFT(a.sitecode, 6) || 'E' = g.sectcode
    OR LEFT(a.sitecode, 6) || 'W' = g.sectcode
  LEFT JOIN public.loc_breeding_sites b ON a.sitecode = b.sitecode
  WHERE a.action = '9'
    AND EXTRACT(YEAR FROM a.inspdate) &gt;= [start_year]
    AND EXTRACT(YEAR FROM a.inspdate) &lt;= [end_year]
    AND (b.enddate IS NULL OR b.enddate &gt; CURRENT_DATE)
    AND g.zone = '[selected_zone]'
    [facility_filter]
  
  UNION ALL
  
  [Same query on dblarv_insptrt_archive]
)
SELECT 
  sitecode,
  facility,
  inspdate as last_inspection,
  wet,
  numdip,
  acres,
  acres_plan
FROM ranked_inspections
WHERE rn = 1
ORDER BY facility, sitecode
</code></pre>

<h5>Mode 2: "Sites NOT checked this year"</h5>
<p>Shows only sites that were inspected historically but have NOT been inspected in the current year.</p>

<p>Uses the same query structure but adds a filter to exclude sites that appear in current year data.</p>

<p><strong>Key Insight</strong>: Mode 2 is a filtered subset of Mode 1, showing only sites that need attention.</p>

<h3>Why COUNT(DISTINCT sitecode)?</h3>
<p>A site can be inspected multiple times in a year (e.g., checkbacks). Using <code>COUNT(DISTINCT sitecode)</code> ensures:</p>
<ul>
<li>Site with 1 inspection = counted once</li>
<li>Site with 5 inspections = counted once</li>
<li>This gives unique site count, not total inspection count</li>
</ul>

<p>Example for Sr facility in 2025:</p>
<ul>
<li>Total inspections: 1,822</li>
<li>Unique sites: 1,662</li>
<li>Difference: 160 sites had multiple inspections</li>
</ul>

<h3>Treatment Planning</h3>

<h3>Purpose</h3>
<p>Show planned treatments (not actual inspections) grouped by facility and plan type.</p>

<h3>Key Features</h3>
<ul>
<li><strong>View by</strong>: Acres or Number of Sites</li>
<li><strong>Facility filter</strong>: Select specific facility or all</li>
<li><strong>Plan type checkboxes</strong>: A, D, G, N, U (different treatment plan categories)</li>
</ul>

<h3>Site Details Table</h3>
<p>Shows site-level treatment planning details including:</p>
<ul>
<li><strong>Site Code</strong> - Unique identifier</li>
<li><strong>Facility</strong> - Responsible facility  </li>
<li><strong>Plan Type</strong> - Treatment plan category (Air, Drone, Ground, None, Unknown)</li>
<li><strong>Inspection Date</strong> - Date of inspection</li>
<li><strong>Wet</strong> - Site wetness status</li>
<li><strong>Num Dip</strong> - Number of dips taken (must be &gt;0 for action='9')</li>
<li><strong>Acres</strong> - Site acres</li>
<li><strong>Acres Plan</strong> - Planned treatment acres</li>
</ul>

<h3>SQL Query Example</h3>
<pre><code class="sql">
SELECT 
  a.sitecode,
  a.facility,
  a.airgrnd_plan,
  a.inspdate,
  a.wet,
  a.numdip,      -- Dip count validation
  a.acres,
  a.acres_plan
FROM public.dblarv_insptrt_current a
LEFT JOIN public.loc_breeding_sites b ON a.sitecode = b.sitecode
WHERE a.action = '9'
  AND a.acres_plan IS NOT NULL
  AND (b.enddate IS NULL OR b.enddate &gt; CURRENT_DATE)
  [facility_filter]
  [plan_types_filter]
ORDER BY a.facility, a.airgrnd_plan, a.sitecode
</code></pre>

<p><strong>NOTE</strong>: This tab's queries and logic are in <code>planned<em>treatment</em>functions.R</code></p>

<h2>Comprehensive SQL Query Examples</h2>

<h3>Progress vs Goal Queries</h3>

<h4>Get Actual Inspections by Year and Zone</h4>
<pre><code class="sql">
-- Query dblarv_insptrt_archive for historical data
SELECT a.facility, g.zone, COUNT(*) AS inspections
FROM public.dblarv_insptrt_archive a
LEFT JOIN public.gis_sectcode g ON LEFT(a.sitecode, 6) || '-' = g.sectcode
  OR LEFT(a.sitecode, 6) || 'N' = g.sectcode
  OR LEFT(a.sitecode, 6) || 'S' = g.sectcode
  OR LEFT(a.sitecode, 6) || 'E' = g.sectcode
  OR LEFT(a.sitecode, 6) || 'W' = g.sectcode
WHERE a.action = '9'
  AND EXTRACT(YEAR FROM a.inspdate) = 2025
  AND a.inspdate &lt;= '2025-11-13'
  AND (a.reinspect IS NULL OR a.reinspect = 'f')
GROUP BY a.facility, g.zone

UNION ALL

-- Query dblarv_insptrt_current for current data
SELECT a.facility, g.zone, COUNT(*) AS inspections
FROM public.dblarv_insptrt_current a
LEFT JOIN public.gis_sectcode g ON LEFT(a.sitecode, 6) || '-' = g.sectcode
  OR LEFT(a.sitecode, 6) || 'N' = g.sectcode
  OR LEFT(a.sitecode, 6) || 'S' = g.sectcode
  OR LEFT(a.sitecode, 6) || 'E' = g.sectcode
  OR LEFT(a.sitecode, 6) || 'W' = g.sectcode
WHERE a.action = '9'
  AND EXTRACT(YEAR FROM a.inspdate) = 2025
  AND a.inspdate &lt;= '2025-11-13'
  AND (a.reinspect IS NULL OR a.reinspect = 'f')
GROUP BY a.facility, g.zone
</code></pre>

<h4>Get Goals from Base Table</h4>
<pre><code class="sql">
SELECT facility, p1_totsitecount, p2_totsitecount 
FROM public.cattail_pctcomplete_base
</code></pre>

<h3>Historical Comparison Queries</h3>

<h4>Historical Baseline (Combined Years)</h4>
<pre><code class="sql">
-- Get historical baseline: all unique sites from last 3 years (2022-2024)
WITH all_inspections AS (
  SELECT 
    a.facility,
    a.sitecode,
    g.zone
  FROM public.dblarv_insptrt_archive a
  LEFT JOIN public.gis_sectcode g ON LEFT(a.sitecode, 6) || '-' = g.sectcode
    OR LEFT(a.sitecode, 6) || 'N' = g.sectcode
    OR LEFT(a.sitecode, 6) || 'S' = g.sectcode
    OR LEFT(a.sitecode, 6) || 'E' = g.sectcode
    OR LEFT(a.sitecode, 6) || 'W' = g.sectcode
  LEFT JOIN public.loc_breeding_sites b ON a.sitecode = b.sitecode
  WHERE a.action = '9'
    AND EXTRACT(YEAR FROM a.inspdate) &gt;= 2022
    AND EXTRACT(YEAR FROM a.inspdate) &lt;= 2024
    AND (a.reinspect IS NULL OR a.reinspect = 'f')
    AND (b.enddate IS NULL OR b.enddate &gt; CURRENT_DATE)
    AND g.zone = '1'
  
  UNION ALL
  
  SELECT 
    a.facility,
    a.sitecode,
    g.zone
  FROM public.dblarv_insptrt_current a
  LEFT JOIN public.gis_sectcode g ON LEFT(a.sitecode, 6) || '-' = g.sectcode
    OR LEFT(a.sitecode, 6) || 'N' = g.sectcode
    OR LEFT(a.sitecode, 6) || 'S' = g.sectcode
    OR LEFT(a.sitecode, 6) || 'E' = g.sectcode
    OR LEFT(a.sitecode, 6) || 'W' = g.sectcode
  LEFT JOIN public.loc_breeding_sites b ON a.sitecode = b.sitecode
  WHERE a.action = '9'
    AND EXTRACT(YEAR FROM a.inspdate) &gt;= 2022
    AND EXTRACT(YEAR FROM a.inspdate) &lt;= 2024
    AND (a.reinspect IS NULL OR a.reinspect = 'f')
    AND (b.enddate IS NULL OR b.enddate &gt; CURRENT_DATE)
    AND g.zone = '1'
)
SELECT 
  facility,
  COUNT(DISTINCT sitecode)::integer as count
FROM all_inspections
GROUP BY facility
ORDER BY facility
</code></pre>

<h4>Current Year Comparison</h4>
<pre><code class="sql">
-- Get current year (2025) unique sites
WITH all_inspections AS (
  SELECT 
    a.facility,
    a.sitecode,
    g.zone
  FROM public.dblarv_insptrt_archive a
  LEFT JOIN public.gis_sectcode g ON LEFT(a.sitecode, 6) || '-' = g.sectcode
    OR LEFT(a.sitecode, 6) || 'N' = g.sectcode
    OR LEFT(a.sitecode, 6) || 'S' = g.sectcode
    OR LEFT(a.sitecode, 6) || 'E' = g.sectcode
    OR LEFT(a.sitecode, 6) || 'W' = g.sectcode
  LEFT JOIN public.loc_breeding_sites b ON a.sitecode = b.sitecode
  WHERE a.action = '9'
    AND EXTRACT(YEAR FROM a.inspdate) = 2025
    AND (a.reinspect IS NULL OR a.reinspect = 'f')
    AND (b.enddate IS NULL OR b.enddate &gt; CURRENT_DATE)
    AND g.zone = '1'
  
  UNION ALL
  
  SELECT 
    a.facility,
    a.sitecode,
    g.zone
  FROM public.dblarv_insptrt_current a
  LEFT JOIN public.gis_sectcode g ON LEFT(a.sitecode, 6) || '-' = g.sectcode
    OR LEFT(a.sitecode, 6) || 'N' = g.sectcode
    OR LEFT(a.sitecode, 6) || 'S' = g.sectcode
    OR LEFT(a.sitecode, 6) || 'E' = g.sectcode
    OR LEFT(a.sitecode, 6) || 'W' = g.sectcode
  LEFT JOIN public.loc_breeding_sites b ON a.sitecode = b.sitecode
  WHERE a.action = '9'
    AND EXTRACT(YEAR FROM a.inspdate) = 2025
    AND (a.reinspect IS NULL OR a.reinspect = 'f')
    AND (b.enddate IS NULL OR b.enddate &gt; CURRENT_DATE)
    AND g.zone = '1'
)
SELECT 
  facility,
  COUNT(DISTINCT sitecode)::integer as count
FROM all_inspections
GROUP BY facility
ORDER BY facility
</code></pre>

<h3>Treatment Planning Queries</h3>

<h4>Get Treatment Plan Summary</h4>
<pre><code class="sql">
SELECT a.facility, a.airgrnd_plan, SUM(a.acres_plan) as total_acres
FROM public.dblarv_insptrt_current a
LEFT JOIN public.loc_breeding_sites b ON a.sitecode = b.sitecode
WHERE a.action = '9'
AND a.acres_plan IS NOT NULL
AND (b.enddate IS NULL OR b.enddate &gt; CURRENT_DATE)
GROUP BY a.airgrnd_plan, a.facility
ORDER BY a.airgrnd_plan, a.facility
</code></pre>

<h4>Get Site Details for Treatment Planning</h4>
<pre><code class="sql">
SELECT 
  a.sitecode,
  a.facility,
  a.airgrnd_plan,
  a.inspdate,
  a.wet,
  a.numdip,
  a.acres,
  a.acres_plan
FROM public.dblarv_insptrt_current a
LEFT JOIN public.loc_breeding_sites b ON a.sitecode = b.sitecode
WHERE a.action = '9'
  AND a.acres_plan IS NOT NULL
  AND (b.enddate IS NULL OR b.enddate &gt; CURRENT_DATE)
  AND a.facility = 'Sr'
  AND a.airgrnd_plan IN ('A', 'D', 'G')
ORDER BY a.facility, a.airgrnd_plan, a.sitecode
</code></pre>

<h2>Code Organization</h2>

<h3>File Structure</h3>
<pre><code class="">
cattail/
├── app.R                          # Main UI and server logic (NO SQL!)
├── progress_functions.R           # Progress vs Goal tab functions
├── historical_functions.R         # Historical Comparison tab functions
├── planned_treatment_functions.R  # Treatment Planning tab functions
├── test_sr_counts.R              # Test script for Sr facility counts
├── test_sr_zone_comparison.R     # Test script for zone-specific counts
└── NOTES.md                       # This file
</code></pre>

<h3>Design Principles</h3>
<ol>
<li><strong>Separation of Concerns</strong>: UI/server in app.R, ALL SQL in function files</li>
<li><strong>No SQL in app.R</strong>: Every query is wrapped in a function</li>
<li><strong>Consistent Patterns</strong>: All tabs follow same structure:</li>
<ul>
<li>eventReactive for data loading on refresh button</li>
<li>Function calls with input parameters</li>
<li>Render functions for plots and tables</li>
</ul>
</ul>

<h3>Function Files</h3>

<h4><code>progress_functions.R</code></h4>
<ul>
<li><code>get<em>progress</em>data(year, goal<em>column, custom</em>today)</code> - Query actuals and goals</li>
<li><code>create<em>progress</em>plot(data)</code> - Render progress bar chart</li>
</ul>

<h4><code>historical_functions.R</code></h4>
<ul>
<li><code>get<em>historical</em>progress<em>data(hist</em>years, hist<em>zone, hist</em>facility_filter)</code> - Query historical + current year data</li>
<li><code>create<em>historical</em>progress<em>plot(data, hist</em>years)</code> - Render side-by-side comparison chart</li>
<li><code>get<em>sites</em>table<em>data(hist</em>years, hist<em>zone, hist</em>facility<em>filter, sites</em>view_type)</code> - Query site details</li>
</ul>

<h4><code>planned<em>treatment</em>functions.R</code></h4>
<ul>
<li>Functions for treatment planning tab (not detailed here)</li>
</ul>

<h3>Shared Utilities (<code>shared/db_helpers.R</code>)</h3>
<ul>
<li><code>get<em>db</em>connection()</code> - Database connection helper</li>
<li><code>get<em>facility</em>choices()</code> - Facility dropdown options</li>
<li><code>get<em>facility</em>base_colors()</code> - Color mapping for facilities</li>
<li><code>get<em>status</em>colors()</code> - Color mapping for status types (active, planned, etc.)</li>
<li><code>map<em>facility</em>names()</code> - Convert facility codes to display names</li>
</ul>


<h3>Date Handling</h3>
<ul>
<li>Dates stored as PostgreSQL <code>date</code> or <code>timestamp</code></li>
<li>Converted to R <code>Date</code> objects</li>
<li>UI date inputs use <code>dateInput()</code> widget</li>
<li>SQL date filtering: <code>EXTRACT(YEAR FROM inspdate) = 2025</code></li>
</ul>

<h2>Performance Considerations</h2>

<h3>Query Optimization</h3>
<ol>
<li><strong>Filter early</strong>: Apply action, year, reinspect filters in WHERE clause before joins</li>
<li><strong>UNION ALL vs UNION</strong>: Use UNION ALL (keeps duplicates) then COUNT DISTINCT instead of UNION (removes duplicates during merge)</li>
<li><strong>Index-friendly</strong>: Year extraction and zone filtering are indexed in database</li>
</ul>

<h3>R-Side Processing</h3>
<ol>
<li><strong>Numeric conversion</strong>: Convert integer64 to numeric immediately after query</li>
<li><strong>Group operations</strong>: Use dplyr for efficient grouping and summarization</li>
<li><strong>Reactive data</strong>: Use <code>eventReactive</code> to load data only on button click, preventing accidental heavy queries</li>
</ul>
    </div>
</body>
</html>
