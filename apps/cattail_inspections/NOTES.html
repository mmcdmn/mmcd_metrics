<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cattail Inspections Progress Dashboard - Technical Documentation</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            line-height: 1.6;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background-color: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1 {
            color: #2c3e50;
            border-bottom: 3px solid #3498db;
            padding-bottom: 10px;
        }
        h2 {
            color: #34495e;
            margin-top: 30px;
            border-bottom: 2px solid #ecf0f1;
            padding-bottom: 8px;
        }
        h3 {
            color: #7f8c8d;
            margin-top: 20px;
        }
        h4 {
            color: #95a5a6;
            margin-top: 15px;
        }
        code {
            background-color: #f8f9fa;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            color: #e74c3c;
        }
        pre {
            background-color: #2c3e50;
            color: #ecf0f1;
            padding: 20px;
            border-radius: 5px;
            overflow-x: auto;
            margin: 15px 0;
            border: 1px solid #34495e;
        }
        pre code {
            background-color: transparent;
            color: #ecf0f1;
            padding: 0;
            border-radius: 0;
            font-size: 0.85em;
        }
        ul, ol {
            margin: 10px 0;
            padding-left: 30px;
        }
        li {
            margin: 5px 0;
        }
        blockquote {
            border-left: 4px solid #3498db;
            background-color: #f8f9fa;
            padding: 10px 20px;
            margin: 20px 0;
            font-style: italic;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }
        th {
            background-color: #f5f5f5;
            font-weight: bold;
        }
        hr {
            border: none;
            height: 2px;
            background-color: #ecf0f1;
            margin: 20px 0;
        }
        p {
            margin: 10px 0;
        }
        a {
            color: #3498db;
            text-decoration: none;
        }
        a:hover {
            text-decoration: underline;
        }
    </style>
    <!-- KaTeX for LaTeX math rendering -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css" integrity="sha384-n8MVd4RsNIU0tAv4ct0nTaAbDJwPJzDEaqSD1odI+WdtXRGWt2kTvGFasHpSy3SV" crossorigin="anonymous">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js" integrity="sha384-XjKyOOlGwcjNTAIQHIpgOno0Hl1YQqzUOEleOLALmuqehneUG+vnGctmUb0ZY0l8" crossorigin="anonymous"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js" integrity="sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05" crossorigin="anonymous"
        onload="renderMathInElement(document.body, {
          delimiters: [
            {left: '$$', right: '$$', display: true},
            {left: '$', right: '$', display: false},
            {left: '\\[', right: '\\]', display: true},
            {left: '\\(', right: '\\)', display: false}
          ]
        });"></script>
</head>
<body>
    <div class="container">
<h1>Cattail Inspections Progress Dashboard - Technical Documentation</h1>

<h2>Overview</h2>
<p>Dashboard to track cattail inspection progress against goals with historical comparison analysis.</p>

<hr>

<h2>Data Sources</h2>

<h3>Action Codes</h3>
<ul>
<li><strong>Action '9'</strong>: Cattail inspections (primary focus)</li>
<li>All other action codes are filtered out</li>
</ul>

<h3>Key Database Tables</h3>
<ul>
<li><strong><code>dblarv<em>insptrt</em>archive</code></strong>: Historical inspection records</li>
<li><strong><code>dblarv<em>insptrt</em>current</code></strong>: Current year inspection records</li>
<li><strong><code>loc<em>breeding</em>sites</code></strong>: Site master data with acres and enddate</li>
<li><strong><code>gis_sectcode</code></strong>: Zone and facility assignments (P1/P2 zones)</li>
<li><strong><code>cattail<em>pctcomplete</em>base</code></strong>: Site count goals by facility (p1<em>totsitecount, p2</em>totsitecount)</li>
</ul>

<h3>Critical Data Fields</h3>
<ul>
<li><strong><code>sitecode</code></strong>: Unique site identifier</li>
<li><strong><code>facility</code></strong>: Facility code from gis_sectcode (NOT from inspection records)</li>
<li><strong><code>zone</code></strong>: P1 (zone='1') or P2 (zone='2') from gis_sectcode</li>
<li><strong><code>inspdate</code></strong>: Date of inspection</li>
<li><strong><code>wet</code></strong>: Whether site was wet during inspection</li>
<li><strong><code>numdip</code></strong>: Number of larvae found per dip</li>
<li><strong><code>acres_plan</code></strong>: Planned acres for treatment (from inspection record)</li>
<li><strong><code>acres</code></strong>: Actual site acres (from loc<em>breeding</em>sites)</li>
<li><strong><code>enddate</code></strong>: Site end date (NULL = active site)</li>
</ul>

<hr>

<h2>Inspection Counting Logic</h2>

<h3>Single Inspection Per Site Rule</h3>
<p><strong>CRITICAL</strong>: Each site should only be counted ONCE per query period, regardless of how many times it was inspected.</p>

<p><strong>Method</strong>: Use <code>ROW_NUMBER()</code> window function partitioned by sitecode, ordered by most recent inspection:</p>
<pre><code class="sql">
ROW_NUMBER() OVER (PARTITION BY a.sitecode ORDER BY a.inspdate DESC) as rn
WHERE rn = 1  -- Only the most recent inspection per site
</code></pre>

<h3>Active Sites Filter</h3>
<p><strong>CRITICAL</strong>: Always filter by enddate to exclude closed/inactive sites:</p>
<pre><code class="sql">
LEFT JOIN public.loc_breeding_sites b ON a.sitecode = b.sitecode
WHERE (b.enddate IS NULL OR b.enddate &gt; CURRENT_DATE)
</code></pre>

<h3>Reinspect Field (DEPRECATED)</h3>
<p>The <code>reinspect</code> field is <strong>NOT RELIABLE</strong> for counting logic:</p>
<ul>
<li><code>reinspect = 't'</code> means "should be re-inspected" but doesn't guarantee it happened</li>
<li><code>reinspect = 'f'</code> or <code>NULL</code> is the first inspection</li>
<li><strong>Solution</strong>: Ignore the <code>reinspect</code> field entirely and use <code>ROW_NUMBER()</code> to ensure one count per site</li>
</ul>

<hr>

<h2>Progress vs Goal Tab</h2>

<h3>Query 1: Get Inspection Counts by Facility and Zone</h3>

<p><strong>Purpose</strong>: Count unique sites inspected per facility/zone for comparison against goals.</p>

<pre><code class="sql">
WITH all_inspections AS (
  SELECT 
    a.facility,
    a.sitecode,
    a.inspdate,
    g.zone,
    ROW_NUMBER() OVER (PARTITION BY a.sitecode ORDER BY a.inspdate DESC) as rn
  FROM (
    -- Archive records
    SELECT facility, sitecode, inspdate 
    FROM public.dblarv_insptrt_archive
    WHERE action = '9'
      AND EXTRACT(YEAR FROM inspdate) = 2025  -- Selected year
      AND inspdate &lt;= '2025-12-04'            -- Custom "today" date
    
    UNION ALL
    
    -- Current records
    SELECT facility, sitecode, inspdate 
    FROM public.dblarv_insptrt_current
    WHERE action = '9'
      AND EXTRACT(YEAR FROM inspdate) = 2025  -- Selected year
      AND inspdate &lt;= '2025-12-04'            -- Custom "today" date
  ) a
  LEFT JOIN public.gis_sectcode g ON g.sectcode = LEFT(a.sitecode, 7)
  LEFT JOIN public.loc_breeding_sites b ON a.sitecode = b.sitecode
  WHERE (b.enddate IS NULL OR b.enddate &gt; CURRENT_DATE)
)
SELECT 
  facility,
  zone,
  COUNT(DISTINCT sitecode) AS inspections
FROM all_inspections
WHERE rn = 1  -- Only most recent inspection per site
GROUP BY facility, zone
</code></pre>

<p><strong>Key Points</strong>:</p>
<ul>
<li>✅ Uses <code>LEFT(a.sitecode, 7)</code> for exact sectcode matching</li>
<li>✅ Filters active sites with enddate check</li>
<li>✅ Uses ROW_NUMBER() to count each site only once</li>
<li>✅ UNION ALL combines archive and current tables</li>
<li>✅ Groups by facility and zone for P1/P2 separation</li>
</ul>

<h3>Query 2: Get Site Details for Table Display</h3>

<p><strong>Purpose</strong>: Retrieve detailed information for each site contributing to the progress chart.</p>

<pre><code class="sql">
WITH all_inspections AS (
  SELECT 
    a.facility,
    a.sitecode,
    a.inspdate,
    a.wet,
    a.numdip,
    g.zone,
    ROW_NUMBER() OVER (PARTITION BY a.sitecode ORDER BY a.inspdate DESC) as rn
  FROM (
    -- Archive records
    SELECT facility, sitecode, inspdate, wet, numdip 
    FROM public.dblarv_insptrt_archive
    WHERE action = '9'
      AND EXTRACT(YEAR FROM inspdate) = 2025
      AND inspdate &lt;= '2025-12-04'
    
    UNION ALL
    
    -- Current records
    SELECT facility, sitecode, inspdate, wet, numdip 
    FROM public.dblarv_insptrt_current
    WHERE action = '9'
      AND EXTRACT(YEAR FROM inspdate) = 2025
      AND inspdate &lt;= '2025-12-04'
  ) a
  LEFT JOIN public.gis_sectcode g ON g.sectcode = LEFT(a.sitecode, 7)
)
SELECT 
  ai.facility,
  ai.sitecode,
  ai.inspdate,
  ai.wet,
  ai.numdip,
  COALESCE(b.acres, 0) as acres
FROM all_inspections ai
LEFT JOIN public.loc_breeding_sites b ON ai.sitecode = b.sitecode
WHERE ai.rn = 1                    -- Most recent inspection only
  AND ai.zone = '1'                -- Selected zone (P1 or P2)
  AND (b.enddate IS NULL OR b.enddate &gt; CURRENT_DATE)
ORDER BY ai.facility, ai.inspdate DESC
</code></pre>

<p><strong>Key Points</strong>:</p>
<ul>
<li>✅ Returns individual site records (not aggregated)</li>
<li>✅ Includes wet, numdip, and acres for detailed analysis</li>
<li>✅ Filters by selected zone (P1 or P2 based on goal selection)</li>
<li>✅ One row per site (most recent inspection)</li>
</ul>

<hr>

<h2>Historical Comparison Tab</h2>

<h3>Query 3: Historical Baseline (Multi-Year Average)</h3>

<p><strong>Purpose</strong>: Calculate average inspection counts over previous N years (excluding current year).</p>

<pre><code class="sql">
WITH all_inspections AS (
  SELECT 
    a.facility,
    a.sitecode,
    g.zone
  FROM public.dblarv_insptrt_archive a
  LEFT JOIN public.gis_sectcode g ON g.sectcode = LEFT(a.sitecode, 7)
  LEFT JOIN public.loc_breeding_sites b ON a.sitecode = b.sitecode
  WHERE a.action = '9'
    AND EXTRACT(YEAR FROM a.inspdate) &gt;= 2022  -- Start year (current - hist_years)
    AND EXTRACT(YEAR FROM a.inspdate) &lt;= 2024  -- End year (current - 1)
    AND g.zone = '1'                            -- Zone filter (P1, P2, combined, or separate)
    AND (b.enddate IS NULL OR b.enddate &gt; CURRENT_DATE)
  
  UNION ALL
  
  SELECT 
    a.facility,
    a.sitecode,
    g.zone
  FROM public.dblarv_insptrt_current a
  LEFT JOIN public.gis_sectcode g ON g.sectcode = LEFT(a.sitecode, 7)
  LEFT JOIN public.loc_breeding_sites b ON a.sitecode = b.sitecode
  WHERE a.action = '9'
    AND EXTRACT(YEAR FROM a.inspdate) &gt;= 2022
    AND EXTRACT(YEAR FROM a.inspdate) &lt;= 2024
    AND g.zone = '1'
    AND (b.enddate IS NULL OR b.enddate &gt; CURRENT_DATE)
)
SELECT 
  facility,
  zone,
  COUNT(DISTINCT sitecode)::integer as site_count,
  SUM(DISTINCT_ACRES.acres)::numeric as acre_count
FROM (
  SELECT DISTINCT
    facility,
    sitecode,
    zone,
    FIRST_VALUE(COALESCE(acres_plan, acres)) OVER (
      PARTITION BY facility, sitecode 
      ORDER BY inspdate DESC
    ) as acres
  FROM (
    -- Get acres_plan from inspection records
    SELECT 
      ai.facility,
      ai.sitecode,
      ai.zone,
      a.inspdate,
      a.acres_plan,
      b.acres
    FROM all_inspections ai
    LEFT JOIN public.dblarv_insptrt_archive a 
      ON ai.sitecode = a.sitecode AND ai.facility = a.facility
    LEFT JOIN public.loc_breeding_sites b ON ai.sitecode = b.sitecode
    WHERE a.action = '9'
      AND EXTRACT(YEAR FROM a.inspdate) &gt;= 2022
      AND EXTRACT(YEAR FROM a.inspdate) &lt;= 2024
    
    UNION ALL
    
    SELECT 
      ai.facility,
      ai.sitecode,
      ai.zone,
      a.inspdate,
      a.acres_plan,
      b.acres
    FROM all_inspections ai
    LEFT JOIN public.dblarv_insptrt_current a 
      ON ai.sitecode = a.sitecode AND ai.facility = a.facility
    LEFT JOIN public.loc_breeding_sites b ON ai.sitecode = b.sitecode
    WHERE a.action = '9'
      AND EXTRACT(YEAR FROM a.inspdate) &gt;= 2022
      AND EXTRACT(YEAR FROM a.inspdate) &lt;= 2024
  ) site_acres
) DISTINCT_ACRES
GROUP BY facility, zone
ORDER BY facility, zone
</code></pre>

<p><strong>Key Points</strong>:</p>
<ul>
<li>✅ CTE filters to historical years only (excludes current year)</li>
<li>✅ Nested query calculates acres using FIRST_VALUE window function</li>
<li>✅ Prefers <code>acres<em>plan</code> from inspection, falls back to <code>acres</code> from loc</em>breeding_sites</li>
<li>✅ COUNT DISTINCT ensures one count per site across all historical years</li>
<li>✅ Returns both site<em>count and acre</em>count metrics</li>
</ul>

<h3>Query 4: Current Year Progress</h3>

<p><strong>Purpose</strong>: Count inspections completed in the current year for comparison against historical baseline.</p>

<pre><code class="sql">
WITH all_inspections AS (
  SELECT 
    a.facility,
    a.sitecode,
    g.zone
  FROM public.dblarv_insptrt_archive a
  LEFT JOIN public.gis_sectcode g ON g.sectcode = LEFT(a.sitecode, 7)
  LEFT JOIN public.loc_breeding_sites b ON a.sitecode = b.sitecode
  WHERE a.action = '9'
    AND EXTRACT(YEAR FROM a.inspdate) = 2025  -- Current year only
    AND g.zone = '1'                          -- Zone filter
    AND (b.enddate IS NULL OR b.enddate &gt; CURRENT_DATE)
  
  UNION ALL
  
  SELECT 
    a.facility,
    a.sitecode,
    g.zone
  FROM public.dblarv_insptrt_current a
  LEFT JOIN public.gis_sectcode g ON g.sectcode = LEFT(a.sitecode, 7)
  LEFT JOIN public.loc_breeding_sites b ON a.sitecode = b.sitecode
  WHERE a.action = '9'
    AND EXTRACT(YEAR FROM a.inspdate) = 2025
    AND g.zone = '1'
    AND (b.enddate IS NULL OR b.enddate &gt; CURRENT_DATE)
)
SELECT 
  facility,
  zone,
  COUNT(DISTINCT sitecode)::integer as site_count,
  SUM(DISTINCT_ACRES.acres)::numeric as acre_count
FROM (
  SELECT DISTINCT
    facility,
    sitecode,
    zone,
    FIRST_VALUE(COALESCE(acres_plan, acres)) OVER (
      PARTITION BY facility, sitecode 
      ORDER BY inspdate DESC
    ) as acres
  FROM (
    SELECT 
      ai.facility,
      ai.sitecode,
      ai.zone,
      a.inspdate,
      a.acres_plan,
      b.acres
    FROM all_inspections ai
    LEFT JOIN public.dblarv_insptrt_archive a 
      ON ai.sitecode = a.sitecode AND ai.facility = a.facility
    LEFT JOIN public.loc_breeding_sites b ON ai.sitecode = b.sitecode
    WHERE a.action = '9'
      AND EXTRACT(YEAR FROM a.inspdate) = 2025
    
    UNION ALL
    
    SELECT 
      ai.facility,
      ai.sitecode,
      ai.zone,
      a.inspdate,
      a.acres_plan,
      b.acres
    FROM all_inspections ai
    LEFT JOIN public.dblarv_insptrt_current a 
      ON ai.sitecode = a.sitecode AND ai.facility = a.facility
    LEFT JOIN public.loc_breeding_sites b ON ai.sitecode = b.sitecode
    WHERE a.action = '9'
      AND EXTRACT(YEAR FROM a.inspdate) = 2025
  ) site_acres
) DISTINCT_ACRES
GROUP BY facility, zone
ORDER BY facility, zone
</code></pre>

<p><strong>Key Points</strong>:</p>
<ul>
<li>✅ Identical structure to historical query but filtered to current year only</li>
<li>✅ Enables side-by-side comparison: Current Year vs Historical Baseline</li>
<li>✅ Both queries share same zone filtering logic for consistency</li>
</ul>

<hr>

<h2>Zone Filtering Options</h2>

<h3>User Interface Options:</h3>
<ol>
<li><strong>P1 Only</strong> (<code>hist_zone = "p1"</code>)</li>
<ul>
<li>SQL: <code>AND g.zone = '1'</code></li>
<li>Groups by facility only</li>
</ul>
</ul>

<ol>
<li><strong>P2 Only</strong> (<code>hist_zone = "p2"</code>)</li>
<ul>
<li>SQL: <code>AND g.zone = '2'</code></li>
<li>Groups by facility only</li>
</ul>
</ul>

<ol>
<li><strong>P1 and P2 Combined</strong> (<code>hist_zone = "combined"</code>)</li>
<ul>
<li>SQL: <code>AND g.zone IN ('1', '2')</code></li>
<li>Groups by facility only (aggregates both zones)</li>
</ul>
</ul>

<ol>
<li><strong>P1 and P2 Separate</strong> (<code>hist_zone = "separate"</code>)</li>
<ul>
<li>SQL: <code>AND g.zone IN ('1', '2')</code></li>
<li>Groups by facility AND zone (shows separate bars)</li>
</ul>
</ul>

<h3>Implementation Pattern:</h3>
<pre><code class="r">
# Dynamic SQL generation based on zone selection
if (hist_zone == "p1") {
  zone_condition &lt;- "AND g.zone = '1'"
  group_by_clause &lt;- "GROUP BY facility"
} else if (hist_zone == "p2") {
  zone_condition &lt;- "AND g.zone = '2'"
  group_by_clause &lt;- "GROUP BY facility"
} else if (hist_zone == "combined") {
  zone_condition &lt;- "AND g.zone IN ('1', '2')"
  group_by_clause &lt;- "GROUP BY facility"
} else if (hist_zone == "separate") {
  zone_condition &lt;- "AND g.zone IN ('1', '2')"
  group_by_clause &lt;- "GROUP BY facility, zone"
}
</code></pre>

<hr>

<h2>Metrics: Sites vs Acres</h2>

<h3>Site-Based Metric (Primary)</h3>
<ul>
<li><strong>Source</strong>: COUNT(DISTINCT sitecode)</li>
<li><strong>Goal Source</strong>: <code>cattail<em>pctcomplete</em>base</code> (p1<em>totsitecount, p2</em>totsitecount)</li>
<li><strong>Use Case</strong>: Measures number of unique locations inspected</li>
<li><strong>Progress Calculation</strong>: <code>(sites<em>inspected / goal</em>sites) * 100</code></li>
</ul>

<h3>Acre-Based Metric (Secondary)</h3>
<ul>
<li><strong>Source</strong>: SUM of acres per unique site</li>
<li><strong>Acre Priority</strong>: <code>COALESCE(acres_plan, acres)</code> - Prefers planned acres, falls back to site master acres</li>
<li><strong>No Goals</strong>: Acre goals NOT stored in database</li>
<li><strong>Use Case</strong>: Measures total area coverage</li>
<li><strong>Note</strong>: Source table in image uses acres for % calculation (different methodology)</li>
</ul>

<h3>Key Difference:</h3>
<ul>
<li><strong>App uses SITES</strong> for % complete (matches database goals)</li>
<li><strong>Source table uses ACRES</strong> for % complete (no goals available in database)</li>
<li>Both are valid but measure different aspects of progress</li>
</ul>

<hr>

<h2>Value Box Color Coding</h2>

<p>Progress indicators use color thresholds:</p>
<pre><code class="r">
if (pct_complete &gt;= 100) {
  color &lt;- "green"    # Goal met or exceeded
} else if (pct_complete &gt;= 75) {
  color &lt;- "yellow"   # 75-99% complete
} else if (pct_complete &gt;= 50) {
  color &lt;- "orange"   # 50-74% complete
} else {
  color &lt;- "red"      # Below 50% complete
}
</code></pre>

<hr>

<h2>Common Pitfalls &amp; Solutions</h2>

<h3>❌ WRONG: Using reinspect field for counting</h3>
<pre><code class="sql">
WHERE (a.reinspect IS NULL OR a.reinspect = 'f')  -- Unreliable!
</code></pre>

<h3>✅ CORRECT: Use ROW_NUMBER() for single count per site</h3>
<pre><code class="sql">
ROW_NUMBER() OVER (PARTITION BY a.sitecode ORDER BY a.inspdate DESC) as rn
WHERE rn = 1
</code></pre>

<h3>❌ WRONG: Ambiguous zone assignment with pattern matching</h3>
<pre><code class="sql">
LEFT JOIN gis_sectcode g ON LEFT(sitecode, 6) || '-' = g.sectcode
  OR LEFT(sitecode, 6) || 'N' = g.sectcode  -- Matches multiple sectcodes!
</code></pre>

<h3>✅ CORRECT: Exact sectcode matching</h3>
<pre><code class="sql">
LEFT JOIN gis_sectcode g ON g.sectcode = LEFT(a.sitecode, 7)
</code></pre>

<h3>❌ WRONG: Forgetting to filter inactive sites</h3>
<pre><code class="sql">
-- Missing enddate filter allows closed sites!
</code></pre>

<h3>✅ CORRECT: Always filter by enddate</h3>
<pre><code class="sql">
LEFT JOIN loc_breeding_sites b ON a.sitecode = b.sitecode
WHERE (b.enddate IS NULL OR b.enddate &gt; CURRENT_DATE)
</code></pre>

<h3>❌ WRONG: Using facility from inspection records</h3>
<pre><code class="sql">
SELECT a.facility  -- May be outdated or incorrect
FROM dblarv_insptrt_archive a
</code></pre>

<h3>✅ CORRECT: Using facility from gis_sectcode</h3>
<pre><code class="sql">
SELECT g.facility  -- Always current, zone-aware
FROM dblarv_insptrt_archive a
LEFT JOIN gis_sectcode g ON g.sectcode = LEFT(a.sitecode, 7)
</code></pre>

<hr>

<h2>Database Schema References</h2>

<h3>gis_sectcode (Zone Master Table)</h3>
<pre><code class="">
sectcode (varchar) - First 7 characters of sitecode
zone (varchar)     - '1' (P1) or '2' (P2)
facility (varchar) - Facility code
</code></pre>

<h3>loc<em>breeding</em>sites (Site Master Table)</h3>
<pre><code class="">
sitecode (varchar) - Unique site identifier
acres (numeric)    - Site acreage
enddate (date)     - Site closure date (NULL = active)
</code></pre>

<h3>cattail<em>pctcomplete</em>base (Goal Table)</h3>
<pre><code class="">
facility (varchar)        - Facility code
p1_totsitecount (integer) - P1 site goal
p2_totsitecount (integer) - P2 site goal
comments (text)           - Goal notes/updates
</code></pre>

<h3>dblarv<em>insptrt</em>archive / current (Inspection Tables)</h3>
<pre><code class="">
sitecode (varchar)    - Site identifier
facility (varchar)    - Facility (DO NOT USE - use gis_sectcode.facility)
action (varchar)      - '9' for inspections
inspdate (date)       - Inspection date
wet (boolean)         - Site wet during inspection
numdip (integer)      - Larvae count per dip
acres_plan (numeric)  - Planned treatment acres
reinspect (boolean)   - Re-inspection flag (UNRELIABLE - DO NOT USE)
</code></pre>

<hr>

<h2>File Structure</h2>

<pre><code class="">
apps/cattail_inspections/
├── app.R                     # Main UI and server logic
├── progress_functions.R      # Progress vs Goal queries and charts
├── historical_functions.R    # Historical comparison queries and charts
├── ui_helper.R              # UI component functions
├── data_functions.R         # Shared data processing utilities
├── display_functions.R      # Shared visualization utilities
└── NOTES.md                 # This documentation file
</code></pre>

<hr>

<h2>Version History</h2>

<ul>
<li><strong>December 2025</strong>: Complete query rewrite with corrected zone assignment logic</li>
<ul>
<li>Fixed ambiguous sectcode JOIN pattern</li>
<li>Removed unreliable reinspect field dependency</li>
<li>Added mandatory loc<em>breeding</em>sites enddate filter</li>
<li>Documented all SQL queries with exact syntax</li>
<li>Clarified single-count-per-site methodology</li>
</ul>
</ul>

<ul>
<li><strong>November 2025</strong>: Added site details table with downloadable CSV</li>
<li><strong>October 2025</strong>: Added historical comparison tab with zone filtering</li>
</ul>
    </div>
</body>
</html>
